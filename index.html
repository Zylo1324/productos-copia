<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="Canvas" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="Canvas" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="color-scheme" content="light dark" />
  <title>Zyl0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"
      }
    }
  </script>
  <script>
    (() => {
      const themeMetas = Array.from(document.querySelectorAll('meta[name="theme-color"]'));
      if (!themeMetas.length) return;

      const applyThemeColor = () => {
        const background = getComputedStyle(document.documentElement).backgroundColor;
        themeMetas.forEach((meta) => meta.setAttribute('content', background));
      };

      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      if (typeof mediaQuery.addEventListener === 'function') {
        mediaQuery.addEventListener('change', applyThemeColor);
      } else if (typeof mediaQuery.addListener === 'function') {
        mediaQuery.addListener(applyThemeColor);
      }

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        applyThemeColor();
      } else {
        document.addEventListener('DOMContentLoaded', applyThemeColor, { once: true });
      }
    })();
  </script>
  <style>
    :root{
      color-scheme:light dark;
      --bg:Canvas;
      --card:Canvas;
      --text:CanvasText;
      --ink:var(--text);
      --bg-light:color-mix(in srgb,var(--bg) 96%,var(--ink) 4%);
      --bg-dark:color-mix(in srgb,var(--bg) 12%,var(--ink) 88%);
      --muted:color-mix(in srgb,var(--ink) 70%,var(--bg));
      --primary:#f28a2d;
      --accent:#1d4ed8;

      --ink-soft:color-mix(in srgb,var(--ink) 78%,var(--bg));
      --field:var(--card);
      --field-focus:color-mix(in srgb,var(--card) 88%,var(--bg));
      --border:color-mix(in srgb,var(--muted) 32%,transparent);
      --pill-bg:color-mix(in srgb,var(--accent) 14%,transparent);
      --pill-ink:var(--accent);
      --btn:var(--primary);
      --btn-ink:color-mix(in srgb,var(--ink) 92%,var(--bg));
      --primary-hover:color-mix(in srgb,var(--primary) 92%,var(--card));
      --primary-active:color-mix(in srgb,var(--primary) 88%,var(--muted));
      --ghost:color-mix(in srgb,var(--card) 86%,var(--bg));
      --ghost-border:color-mix(in srgb,var(--muted) 38%,transparent);
      --ghost-hover-bg:color-mix(in srgb,var(--ghost) 80%,var(--accent) 20%);
      --ghost-active-bg:color-mix(in srgb,var(--ghost) 68%,var(--accent) 32%);
      --ghost-hover-border:color-mix(in srgb,var(--accent) 38%,transparent);
      --ghost-active-border:color-mix(in srgb,var(--accent) 48%,transparent);
      --ok:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --link:#2563eb;
      --link-hover:color-mix(in srgb,var(--accent) 35%,var(--bg));
      --link-active:color-mix(in srgb,var(--accent) 55%,var(--bg));
      --success:#16f2a6;
      --danger:#f97373;
      --shadow:0 4px 12px color-mix(in srgb,var(--text) 12%,transparent);
      --shadow-strong:0 12px 28px color-mix(in srgb,var(--text) 18%,transparent);
      --shadow-float:0 10px 20px color-mix(in srgb,var(--text) 22%,transparent);
      --primary-shadow:0 8px 18px color-mix(in srgb,var(--primary) 28%,transparent);
      --panel-shadow-lg:0 20px 38px -24px color-mix(in srgb,var(--text) 24%,transparent);
      --toolbar-bg:color-mix(in srgb,var(--card) 92%,transparent);
      --input-bg:var(--card);
      --input-border:color-mix(in srgb,var(--muted) 42%,transparent);
      --input-focus-border:color-mix(in srgb,var(--accent) 48%,transparent);
      --input-focus-shadow:color-mix(in srgb,var(--accent) 18%,transparent);
      --input-inner-shadow:inset 0 1px 0 color-mix(in srgb,var(--muted) 16%,transparent);
      --ghost-inner-shadow:inset 0 1px 0 color-mix(in srgb,var(--card) 60%,transparent);
      --surface-inner-shadow:inset 0 1px 0 color-mix(in srgb,var(--muted) 12%,transparent);
      --card-bg:var(--card);
      --table-card-bg:var(--card);
      --table-border:color-mix(in srgb,var(--muted) 24%,transparent);
      --table-row-alt-bg:color-mix(in srgb,var(--bg) 74%,var(--accent) 26%);
      --table-row-hover-bg:color-mix(in srgb,var(--accent) 16%,transparent);
      --table-row-hover-shadow:inset 0 0 0 999px color-mix(in srgb,var(--text) 8%,transparent);
      --menu-bg:var(--card);
      --menu-hover-bg:color-mix(in srgb,var(--bg) 86%,var(--accent) 14%);
      --modal-bg:var(--card);
      --backdrop-bg:color-mix(in srgb,var(--text) 35%,transparent);
      --eye-bg:color-mix(in srgb,var(--card) 82%,var(--bg));
      --eye-border:color-mix(in srgb,var(--muted) 52%,transparent);
      --addserv-bg:color-mix(in srgb,var(--accent) 28%,var(--bg));
      --addserv-border:color-mix(in srgb,var(--accent) 45%,transparent);
      --addserv-hover-bg:color-mix(in srgb,var(--accent) 32%,var(--bg));
      --addserv-hover-border:color-mix(in srgb,var(--accent) 55%,transparent);
      --addserv-active-bg:color-mix(in srgb,var(--accent) 38%,var(--bg));
      --addserv-active-border:color-mix(in srgb,var(--accent) 65%,transparent);
      --addserv-ink:var(--accent);
      --tag-border:color-mix(in srgb,var(--muted) 36%,transparent);
      --tag-bg:color-mix(in srgb,var(--bg) 82%,var(--muted) 18%);
      --tag-ok-bg:color-mix(in srgb,var(--ok) 18%,transparent);
      --tag-ok-border:color-mix(in srgb,var(--ok) 38%,transparent);
      --tag-warn-bg:color-mix(in srgb,var(--warn) 18%,transparent);
      --tag-warn-border:color-mix(in srgb,var(--warn) 38%,transparent);
      --tag-bad-bg:color-mix(in srgb,var(--bad) 18%,transparent);
      --tag-bad-border:color-mix(in srgb,var(--bad) 40%,transparent);
      --danger-soft-ink:color-mix(in srgb,var(--bad) 26%,var(--card));
      --logo-highlight:color-mix(in srgb,var(--primary) 55%,var(--warn) 45%);
      --launcher-grad:linear-gradient(150deg,var(--card) 0%,color-mix(in srgb,var(--card) 82%,var(--accent) 18%) 100%);
      --sidebar-grad:linear-gradient(180deg,var(--card) 0%,color-mix(in srgb,var(--card) 80%,var(--bg)) 100%);
      --panel-grad:linear-gradient(180deg,var(--card) 0%,color-mix(in srgb,var(--card) 78%,var(--bg)) 100%);
      --tag-grad:linear-gradient(135deg,color-mix(in srgb,var(--bg) 92%,var(--muted) 8%) 0%,color-mix(in srgb,var(--bg) 82%,var(--muted) 18%) 100%);
      --table-hover-shadow:inset 0 0 0 999px color-mix(in srgb,var(--accent) 12%,transparent);
      --launcher-focus-outline:color-mix(in srgb,var(--accent) 35%,transparent);
      --action-focus-outline:color-mix(in srgb,var(--accent) 45%,transparent);
      --danger-ghost-bg:color-mix(in srgb,var(--bad) 18%,transparent);
      --danger-ghost-border:color-mix(in srgb,var(--bad) 45%,transparent);
      --danger-ghost-active:color-mix(in srgb,var(--bad) 32%,transparent);
      --menu-danger-bg:color-mix(in srgb,var(--bad) 12%,transparent);
      --menu-danger-border:color-mix(in srgb,var(--bad) 35%,transparent);
      --modal-grad:linear-gradient(180deg,var(--card) 0%,color-mix(in srgb,var(--card) 74%,var(--bg)) 100%);
      --radial-accent:color-mix(in srgb,var(--accent) 24%,transparent);
      --radial-success:color-mix(in srgb,var(--success) 18%,transparent);
      --radial-primary:color-mix(in srgb,var(--primary) 18%,transparent);
      --scrollbar-thumb:color-mix(in srgb,var(--accent) 65%,transparent);
      --scrollbar-track:transparent;
    }

    @media(prefers-color-scheme:dark){
      :root{
        color-scheme:light dark;
        --bg-light:color-mix(in srgb,var(--bg) 18%,var(--ink) 82%);
        --bg-dark:color-mix(in srgb,var(--bg) 6%,var(--ink) 94%);
        --muted:color-mix(in srgb,var(--ink) 55%,var(--bg));
        --primary:#f59e0b;
        --accent:#60a5fa;
        --btn-ink:color-mix(in srgb,var(--bg) 80%,var(--ink) 20%);
        --ok:#34d399;
        --warn:#fbbf24;
        --bad:#fb7185;
        --link:#93c5fd;
        --success:#16f2a6;
        --danger:#fb7185;
        --logo-highlight:color-mix(in srgb,var(--primary) 45%,var(--warn) 55%);
      }
    }

    html[data-theme="light"]{
      color-scheme:light;
      --bg:Canvas;
      --card:Canvas;
      --text:CanvasText;
      --ink:var(--text);
      --bg-light:color-mix(in srgb,var(--bg) 96%,var(--ink) 4%);
      --bg-dark:color-mix(in srgb,var(--bg) 12%,var(--ink) 88%);
      --muted:color-mix(in srgb,var(--ink) 70%,var(--bg));
      --btn-ink:color-mix(in srgb,var(--ink) 92%,var(--bg));
      --logo-highlight:color-mix(in srgb,var(--primary) 55%,var(--warn) 45%);
    }

    html[data-theme="dark"]{
      color-scheme:dark;
      --bg:Canvas;
      --card:Canvas;
      --text:CanvasText;
      --ink:var(--text);
      --bg-light:color-mix(in srgb,var(--bg) 18%,var(--ink) 82%);
      --bg-dark:color-mix(in srgb,var(--bg) 6%,var(--ink) 94%);
      --muted:color-mix(in srgb,var(--ink) 55%,var(--bg));
      --btn-ink:color-mix(in srgb,var(--bg) 80%,var(--ink) 20%);
      --primary:#f59e0b;
      --accent:#60a5fa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --link:#93c5fd;
      --success:#16f2a6;
      --danger:#fb7185;
      --logo-highlight:color-mix(in srgb,var(--primary) 45%,var(--warn) 55%);
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--ink)}
    body{position:relative;min-height:100vh;overflow-x:hidden;padding-left:0;transition:padding-left .3s ease}
    .landing{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:40px;padding:48px 16px;text-align:center}
    .landing[hidden]{display:none}
    .landing-hero{max-width:640px;display:grid;gap:18px;justify-items:center}
    .landing-logo{width:84px;height:84px;border-radius:24px;background:linear-gradient(135deg,var(--btn),var(--logo-highlight));display:flex;align-items:center;justify-content:center;font-size:42px;box-shadow:var(--shadow-strong)}
    .landing-pill{padding:6px 16px;border-radius:999px;background:var(--pill-bg);color:var(--pill-ink);border:1px solid var(--border);font-size:12px;letter-spacing:.08em;text-transform:uppercase;margin:0}
    .landing-title{margin:0;font-size:clamp(34px,8vw,68px);font-weight:800;color:var(--ink);text-shadow:0 14px 32px color-mix(in srgb,var(--text) 45%,transparent)}
    .landing-subtitle{margin:0;color:var(--ink-soft);font-size:16px;line-height:1.6}
    .landing-actions{display:flex;gap:14px;flex-wrap:wrap;justify-content:center}
    .landing-panels{width:min(520px,92vw);display:grid;gap:20px}
    .landing-panel{background:var(--panel-grad);border-radius:20px;border:1px solid var(--border);padding:28px;box-shadow:var(--shadow);text-align:left;display:grid;gap:18px}
    .landing-panel[hidden]{display:none}
    .landing-panel h2{margin:0;font-size:24px;font-weight:700;color:var(--ink)}
    .landing-panel p{margin:0;color:var(--muted);line-height:1.5}
    .landing-form{display:grid;gap:16px}
    .landing-errors{min-height:18px;font-size:13px;color:var(--danger)}
    .landing-errors:empty{display:none}
    .landing-google{display:grid;gap:8px}
    .landing-google .small{margin:0;text-align:left}
    @media(max-width:600px){
      .landing{padding:36px 14px}
      .landing-actions{flex-direction:column}
      .landing-panel{padding:24px}
    }
    body.scroll-animations-ready .scroll-fade{opacity:0;transform:translateY(36px)}
    body.scroll-animations-ready .scroll-fade.is-visible{opacity:1;transform:none}
    @media(prefers-reduced-motion:reduce){
      body.scroll-animations-ready .scroll-fade{opacity:1;transform:none;transition:none}
    }
    body::before{
      content:"";
      position:fixed;
      inset:-40%;
      background:
        radial-gradient(circle at 20% 20%,var(--radial-accent),transparent 45%),
        radial-gradient(circle at 80% 10%,var(--radial-success),transparent 52%),
        radial-gradient(circle at 30% 80%,var(--radial-primary),transparent 55%);
      pointer-events:none;
      z-index:-1;
    }
    
    a{color:inherit}

    body.sidebar-expanded{padding-left:260px}
    /* ===== Sidebar y lanzador flotante ===== */
    .sidebar-launcher{position:fixed;top:20px;left:20px;width:54px;height:54px;border-radius:999px;border:1px solid var(--ghost-border);background:var(--launcher-grad);color:var(--ink);display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;z-index:60;box-shadow:var(--shadow-float);transition:left .3s ease,transform .2s ease,box-shadow .2s ease,background-color .2s ease,border-color .2s ease}
    .sidebar-launcher:hover,.sidebar-launcher:focus-visible{transform:translateY(-1px);box-shadow:var(--shadow-float);background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .sidebar-launcher:active{transform:translateY(0);box-shadow:var(--shadow)}
    .sidebar-launcher:focus-visible{outline:2px solid var(--launcher-focus-outline);outline-offset:3px}
    .sidebar-launcher.is-open{background:var(--btn);color:var(--btn-ink);border-color:var(--ghost-hover-border);box-shadow:var(--shadow-strong)}
    .sidebar-launcher.is-open:hover,.sidebar-launcher.is-open:focus-visible{background:var(--primary-hover)}
    body.sidebar-expanded .sidebar-launcher{left:220px}
    .sidebar{position:fixed;inset:0 auto 0 0;width:260px;background:var(--sidebar-grad);border-right:1px solid var(--border);box-shadow:var(--shadow);padding:60px 20px 20px;display:flex;flex-direction:column;z-index:30;transition:transform .3s ease;overflow:hidden;transform:translateX(-100%)}
    .sidebar.pinned,.sidebar.peek{transform:translateX(0)}
    .sidebar.pinned,.sidebar.peek{box-shadow:var(--shadow)}
    .sidebar .sidebar-content{position:relative;height:100%;overflow-y:auto;padding-right:6px}
    .sidebar .label{transition:opacity .2s ease}
    .btn{border:0;border-radius:14px;padding:10px 16px;cursor:pointer;font-weight:600;transition:background-color .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease,color .2s ease;color:var(--ink)}
    .btn.ghost{background:var(--ghost);border:1px solid var(--ghost-border);box-shadow:var(--ghost-inner-shadow)}
    .btn.primary{background:var(--btn);color:var(--btn-ink);box-shadow:var(--primary-shadow)}
    .btn:hover,.btn:focus-visible{box-shadow:var(--shadow-float);transform:translateY(-1px)}
    .btn:active{transform:translateY(0);box-shadow:var(--shadow)}
    .btn.ghost:hover,.btn.ghost:focus-visible{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .btn.ghost:active{background:var(--ghost-active-bg);border-color:var(--ghost-active-border)}
    .btn.primary:hover,.btn.primary:focus-visible{background:var(--primary-hover)}
    .btn.primary:active{background:var(--primary-active)}
    .btn:focus-visible{outline:2px solid var(--action-focus-outline);outline-offset:3px}
    .linklike{background:none;border:0;color:var(--link);cursor:pointer;padding:0;font-weight:600;position:relative;transition:color .2s ease}
    .linklike::after{content:"";position:absolute;left:0;bottom:-2px;width:100%;height:2px;background:currentColor;transform:scaleX(0);transform-origin:left;transition:transform .2s ease}
    .linklike:hover,.linklike:focus-visible{color:var(--link-hover)}
    .linklike:hover::after,.linklike:focus-visible::after{transform:scaleX(1)}
    .linklike:active{color:var(--link-active)}
    .linklike:active::after{transform:scaleX(1)}

    /* ===== Layout ===== */
    .layout-shell{width:min(1200px,92vw);margin:0 auto;min-height:100vh;display:grid;align-content:center;justify-items:center;gap:24px;padding-block:24px}
    #Header,#BarraServicio,#AppGrid{width:min(1200px,92vw);margin:0 auto}
    #Header{padding:36px clamp(16px,4vw,28px) 0;position:relative;z-index:0}
    #BarraServicio{padding:0 clamp(16px,4vw,28px)}
    #AppMain{padding-bottom:24px}
    .app-view[hidden]{display:none}
    .view-container{width:min(1200px,92vw);margin:0 auto}
    .view-note{margin:32px auto 12px;color:var(--muted);font-size:14px;line-height:1.5}
    .view-nav{display:flex;justify-content:flex-end;gap:12px;margin:0 auto 24px}
    .view-nav .btn{flex:0 0 auto}
    #AppGrid{padding:0 clamp(16px,4vw,28px) 24px;margin-top:32px;display:grid;grid-template-columns:minmax(0,1fr);grid-template-areas:"form" "acciones";gap:24px}
    #Formulario{grid-area:form}
    #AccionesRapidas{grid-area:acciones}
    #TablaClientes{margin-top:0}
    @media(min-width:960px){
      #AppGrid{grid-template-columns:minmax(0,2fr)minmax(0,1fr);grid-template-areas:"form acciones";}
    }
    .pill{display:block;width:max-content;margin:0 auto 14px;padding:6px 14px;border-radius:999px;background:var(--pill-bg);color:var(--pill-ink);border:1px solid var(--border);font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .hero-brand{margin:12px auto 32px;font-weight:700;letter-spacing:-0.04em;font-size:clamp(38px,14vw,112px);line-height:1;text-align:center;color:var(--ink);text-shadow:none}
    @media(max-width:520px){
      .hero-brand{font-size:clamp(32px,18vw,72px)}
    }

    /* ===== Servicio centrado ===== */
    .center{display:flex;justify-content:center;align-items:center;gap:16px;margin:8px 0 20px;flex-wrap:wrap}
    #BarraServicio{gap:10px}
    .center > *{flex:0 0 auto}
    .center button{flex:0 0 auto}
    .center .service-group{display:flex;align-items:center;gap:8px;flex:0 1 auto;justify-content:flex-start}
    .center .service-group .label{color:var(--ink);font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-size:14px}
    .center .service-group select{flex:1 1 240px;min-width:200px}
    .addserv{border:1px solid var(--addserv-border);background:var(--addserv-bg);color:var(--addserv-ink);width:44px;height:44px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;line-height:1;cursor:pointer;transition:background-color .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease,color .2s ease;box-shadow:var(--shadow-float)}
    .addserv:hover,.addserv:focus-visible{background:var(--addserv-hover-bg);border-color:var(--addserv-hover-border);box-shadow:var(--shadow-float);transform:translateY(-1px)}
    .addserv:active{background:var(--addserv-active-bg);border-color:var(--addserv-active-border);transform:translateY(0);box-shadow:var(--shadow)}
    .addserv:focus-visible{outline:2px solid var(--action-focus-outline);outline-offset:2px}
    .addserv.remove{border-color:var(--danger-ghost-border);color:var(--danger-soft-ink);background:var(--danger-ghost-bg)}
    .addserv.remove:hover,.addserv.remove:focus-visible{background:color-mix(in srgb,var(--danger-ghost-bg) 85%,var(--danger));border-color:color-mix(in srgb,var(--danger-ghost-border) 85%,var(--danger))}
    .addserv.remove:active{background:var(--danger-ghost-active);border-color:color-mix(in srgb,var(--danger-ghost-border) 95%,var(--danger))}

    /* ===== Form (labels arriba) ===== */
    .form{background:var(--panel-grad);border-radius:20px;border:1px solid var(--border);padding:28px;box-shadow:var(--shadow)}
    .form-grid{display:grid;gap:16px}
    @media(min-width:720px){
      .form-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    .row{display:flex;flex-direction:column;gap:6px}
    .form-grid .row{min-width:0}
    .span-2{grid-column:1 / -1}
    .row label{color:var(--ink-soft);font-size:13px;font-weight:600;letter-spacing:.04em;text-transform:uppercase}
    input,select,textarea{width:100%;padding:14px;border:1px solid var(--input-border);border-radius:14px;background:var(--field);color:var(--ink);outline:none;transition:.15s;box-shadow:var(--input-inner-shadow)}
    input::placeholder,textarea::placeholder{color:var(--muted)}
    input:focus,select:focus,textarea:focus{border-color:var(--input-focus-border);background:var(--field-focus);box-shadow:0 0 0 3px var(--input-focus-shadow)}
    textarea{min-height:88px;resize:vertical}
    .actions{display:flex;justify-content:center;gap:10px;margin-top:18px;flex-wrap:wrap}
    .actions .btn{flex:1 1 140px}
    .small{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    .side-card{background:var(--panel-grad);border-radius:20px;border:1px solid var(--border);padding:28px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:18px}
    .side-card h2{margin:0;font-size:18px;color:var(--ink);font-weight:700}
    .side-card p{margin:0;color:var(--muted);font-size:14px}
    .side-card .actions{flex-direction:column;justify-content:flex-start}
    .side-card .actions .btn{width:100%}
    .side-card .small{text-align:left;margin-top:0}
    .pin-wrap{position:relative}
    .pin-wrap .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--eye-border);background:var(--eye-bg);color:var(--ink);border-radius:10px;padding:6px 8px;cursor:pointer;transition:background-color .2s ease,border-color .2s ease}
    .pin-wrap .eye:hover,.pin-wrap .eye:focus-visible{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .pin-wrap .eye:focus-visible{outline:2px solid var(--action-focus-outline);outline-offset:2px}

    .phone-row .phone-control{position:relative;display:flex;align-items:center;gap:0;border:1px solid var(--input-border);border-radius:14px;background:var(--field);box-shadow:var(--input-inner-shadow);transition:border-color .15s ease,box-shadow .15s ease,background-color .15s ease}
    .phone-row .phone-control:focus-within{border-color:var(--input-focus-border);background:var(--field-focus);box-shadow:0 0 0 3px var(--input-focus-shadow)}
    .phone-row .phone-country{display:flex;align-items:center;gap:8px;height:100%;padding:0 14px;border:0;border-right:1px solid var(--input-border);background:transparent;color:var(--ink);cursor:pointer;font-weight:600}
    .phone-row .phone-country:hover,.phone-row .phone-country:focus-visible{background:var(--ghost-hover-bg)}
    .phone-row .phone-country:focus-visible{outline:2px solid var(--action-focus-outline);outline-offset:2px}
    .phone-row .phone-flag{font-size:18px;line-height:1}
    .phone-row .phone-code{font-size:14px}
    .phone-row .phone-caret{font-size:10px;margin-left:2px;color:var(--muted)}
    .phone-row input{border:0;background:transparent;padding:14px 16px;box-shadow:none;color:var(--ink);font-size:15px}
    .phone-row input:focus{border:0;box-shadow:none}
    .phone-dropdown{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--menu-bg);border:1px solid var(--ghost-border);border-radius:14px;box-shadow:var(--shadow);max-height:260px;overflow:auto;display:none;z-index:50;padding:6px 0}
    .phone-dropdown.open{display:block}
    .phone-option{width:100%;display:flex;align-items:center;gap:12px;padding:10px 16px;border:0;background:transparent;color:var(--ink);cursor:pointer;text-align:left;font-size:14px}
    .phone-option:hover,.phone-option:focus-visible{background:var(--menu-hover-bg);outline:none}
    .phone-option[aria-selected="true"]{background:var(--table-row-hover-bg);box-shadow:var(--table-row-hover-shadow)}
    .phone-option .phone-option-flag{font-size:18px}
    .phone-option .phone-option-meta{display:flex;justify-content:space-between;gap:12px;flex:1 1 auto;align-items:center}
    .phone-option .phone-option-name{font-weight:600}
    .phone-option .phone-option-code{color:var(--muted);font-weight:500}
    @media(max-width:520px){
      .phone-row .phone-country{padding:0 10px}
      .phone-option .phone-option-meta{flex-direction:column;align-items:flex-start;gap:2px}
    }

    /* email dropdown toggle */
    .row.suggestion-source{position:relative}
    .row.suggestion-source input{padding-right:44px}
    .email-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--eye-border);background:var(--eye-bg);color:var(--ink);border-radius:10px;padding:6px 8px;cursor:pointer;line-height:1}
    .email-toggle:hover,.email-toggle:focus-visible{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .email-toggle:focus-visible{outline:2px solid var(--action-focus-outline);outline-offset:2px}

    .btn.icon-only{width:44px;height:44px;padding:0;display:flex;align-items:center;justify-content:center;font-size:24px;line-height:1}
    .btn.ghost.danger{color:var(--danger);border-color:var(--danger-ghost-border)}
    .btn.ghost.danger:hover,.btn.ghost.danger:focus-visible{background:var(--danger-ghost-bg);border-color:var(--danger-ghost-border)}
    .btn.ghost.danger:active{background:var(--danger-ghost-active);border-color:color-mix(in srgb,var(--danger-ghost-border) 90%,var(--danger))}
    .btn.ghost.danger:disabled{opacity:.4;cursor:not-allowed;box-shadow:none;transform:none}

    .row.suggestion-source .suggestion-dropdown,
    .row.suggestion-source .suggestion-dropdown.open{left:0;right:0}

    .suggestion-dropdown{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--menu-bg);border:1px solid var(--ghost-border);border-radius:14px;padding:6px 0;box-shadow:var(--shadow);display:none;z-index:40;max-height:260px;overflow:auto}
    .suggestion-dropdown.open{display:block}
    .suggestion-item{width:100%;text-align:left;background:none;border:0;color:var(--ink);padding:10px 16px;cursor:pointer;display:flex;flex-direction:column;gap:4px;font-size:14px}
    .suggestion-item:hover,.suggestion-item:focus-visible{background:var(--menu-hover-bg);outline:none}
    .suggestion-item.is-active{background:var(--table-row-hover-bg);box-shadow:var(--table-row-hover-shadow)}
    .suggestion-email{font-weight:600}
    .suggestion-hint{color:var(--muted);font-size:12px}
    .suggestion-empty{padding:12px 16px;color:var(--muted);font-size:13px}

    /* ===== Tabla ===== */
    .table-section{margin-top:40px;display:flex;flex-direction:column;gap:18px}
    .table-header{display:flex;flex-direction:column;gap:6px}
    @media(min-width:720px){
      .table-header{flex-direction:row;align-items:flex-end;justify-content:space-between}
    }
    .table-header h2{margin:0;font-size:22px;font-weight:700;color:var(--ink);text-shadow:0 10px 20px color-mix(in srgb,var(--text) 35%,transparent)}
    .table-header p{margin:0;color:var(--muted);font-size:14px}
    .table-card{position:relative;background:var(--panel-grad);border-radius:20px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:visible}
    .table-scroll{position:relative;width:100%;overflow-x:auto;overscroll-behavior-x:contain;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--scrollbar-thumb) var(--scrollbar-track);scrollbar-gutter:stable both-edges}
    .table-scroll:focus-visible{outline:2px solid var(--action-focus-outline);outline-offset:4px}
    .table-scroll::-webkit-scrollbar{height:10px}
    .table-scroll::-webkit-scrollbar-track{background:transparent}
    .table-scroll::-webkit-scrollbar-thumb{background:var(--scrollbar-thumb);border-radius:999px;border:3px solid var(--scrollbar-track)}
    table{width:100%;min-width:100%;border-collapse:separate;border-spacing:0;border-radius:inherit}
    th,td{padding:14px 16px;border-bottom:1px solid var(--table-border);font-size:14px;word-break:break-word;overflow-wrap:anywhere}
    th{text-align:left;color:var(--muted);font-weight:700;letter-spacing:.08em;font-size:12px;text-transform:uppercase}
    td{color:var(--ink);font-weight:500}
    tbody tr:nth-child(even){background:var(--table-row-alt-bg)}
    tbody tr:hover{background:var(--table-row-hover-bg);box-shadow:var(--table-row-hover-shadow)}
    thead th:first-child{border-top-left-radius:20px}
    thead th:last-child{border-top-right-radius:20px}
    tbody tr:last-child td:first-child{border-bottom-left-radius:20px}
    tbody tr:last-child td:last-child{border-bottom-right-radius:20px}
    .table-card th,.table-card td{background-clip:padding-box}
    .cell-actions{text-align:right}
    @media(max-width:639px){
      .table-card{padding:12px}
      .table-scroll{scrollbar-width:auto}
      #tabla{display:block}
      #tabla thead{display:none}
      #tabla tbody{display:grid;gap:16px;padding:4px 0}
      #tabla tbody tr{display:grid;grid-template-columns:1fr;gap:12px;padding:18px;border-radius:18px;border:1px solid var(--table-border);background:var(--table-card-bg);box-shadow:var(--shadow)}
      #tabla tbody tr:nth-child(even){background:var(--table-card-bg)}
      #tabla tbody tr:hover{background:var(--table-row-hover-bg);box-shadow:0 6px 16px color-mix(in srgb,var(--text) 16%,transparent)}
      #tabla tbody tr td{display:grid;gap:6px;padding:0;border:0;background:transparent;text-align:left}
      #tabla tbody tr td::before{content:attr(data-label);font-size:12px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
      #tabla tbody tr td[data-label=""]::before{content:'';display:none}
      #tabla tbody tr td .tag{justify-self:start}
      .cell-actions{justify-items:end}
      .cell-actions .menu-wrap{justify-self:end}
    }
    @media(min-width:640px){
      #tabla{display:table}
      .table-scroll thead th{position:sticky;top:0;background:var(--table-card-bg);z-index:2;box-shadow:0 1px 0 var(--table-border)}
      #tabla thead{display:table-header-group}
      #tabla tbody{display:table-row-group}
      #tabla tbody tr{display:table-row}
      #tabla tbody tr td{display:table-cell;padding:14px 16px}
      #tabla tbody tr td::before{display:none}
    }
    .tag{font-size:12px;padding:4px 10px;border-radius:999px;display:inline-block;border:1px solid var(--tag-border);background:var(--tag-grad);color:var(--ink)}
    .tag.ok{color:var(--ok);background:var(--tag-ok-bg);border-color:var(--tag-ok-border)}
    .tag.warn{color:var(--warn);background:var(--tag-warn-bg);border-color:var(--tag-warn-border)}
    .tag.bad{color:var(--bad);background:var(--tag-bad-bg);border-color:var(--tag-bad-border)}

    /* ===== Kebab ⋯ menú ===== */
    .menu-wrap{position:relative;display:inline-flex;align-items:center;gap:8px}
    .row-menu-indicator{border:1px solid var(--ghost-border);background:var(--ghost);border-radius:12px;padding:6px 10px;line-height:1;color:var(--ink-soft);font-size:18px;letter-spacing:2px;transition:background-color .2s ease,border-color .2s ease,color .2s ease;user-select:none}
    tr[aria-expanded="true"] .row-menu-indicator{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border);color:var(--ink)}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:var(--panel-grad);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);min-width:180px;padding:8px;opacity:0;visibility:hidden;pointer-events:none;transform:translateY(-6px);transition:opacity .2s ease,transform .2s ease;z-index:50}
    .menu.open{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
    .menu-item{display:block;width:100%;text-align:left;background:transparent;border:1px solid transparent;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px;color:var(--ink);transition:background-color .15s ease,border-color .15s ease,color .15s ease}
    .menu-item:hover{background:var(--menu-hover-bg)}
    .menu-item.danger{color:var(--bad);border:1px solid var(--menu-danger-border);background:var(--menu-danger-bg)}
    .menu-item.danger:hover{background:color-mix(in srgb,var(--menu-danger-bg) 85%,var(--bad));border-color:var(--menu-danger-border)}

    /* ===== Modales ===== */
    .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:var(--backdrop-bg);opacity:0;visibility:hidden;pointer-events:none;transform:translateY(6px);transition:opacity .2s ease,transform .2s ease;z-index:100}
    .modal-backdrop.open{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
    .modal{background:var(--modal-grad);border:1px solid var(--border);border-radius:18px;width:min(760px,96vw);max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow);color:var(--ink)}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border)}
    .modal .body{padding:16px 18px;color:var(--ink)}
    .email-linker-modal .body{display:flex;flex-direction:column;gap:18px}
    .email-linker-fields{display:flex;flex-direction:column;gap:16px}
    .email-linker-input{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
    @media(max-width:520px){
      .email-linker-input{grid-template-columns:1fr;align-items:stretch}
      .email-linker-input button{width:100%}
    }
    .email-linker-list{border:1px solid var(--ghost-border);background:var(--ghost);border-radius:14px;overflow:hidden;max-height:220px;overflow-y:auto}
    .email-linker-empty{padding:18px;text-align:center;color:var(--ink-soft);font-size:14px}
    .email-linker-item{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;gap:12px}
    .email-linker-item + .email-linker-item{border-top:1px solid var(--ghost-border)}
    .email-linker-mail{font-weight:500;word-break:break-all}
    .email-linker-remove{border:1px solid var(--danger-ghost-border);background:var(--danger-ghost-bg);color:var(--danger);border-radius:10px;padding:6px 10px;font-weight:600;cursor:pointer;transition:background-color .2s ease,border-color .2s ease,color .2s ease,transform .2s ease}
    .email-linker-remove:hover,.email-linker-remove:focus-visible{background:color-mix(in srgb,var(--danger) 18%,transparent);border-color:color-mix(in srgb,var(--danger) 55%,transparent);outline:2px solid var(--danger-ghost-border);outline-offset:2px}
    .email-linker-remove:active{transform:translateY(1px)}
    .email-linker-error{min-height:18px;font-size:13px;color:var(--danger)}
    .settings-description{margin:0 0 12px;color:var(--muted)}
    .settings-fieldset{border:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}
    .settings-fieldset legend{font-weight:600;margin-bottom:4px}
    .settings-group{display:flex;flex-direction:column;gap:8px}
    .settings-option{display:flex;align-items:center;gap:12px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--field);cursor:pointer;transition:background .2s ease,border-color .2s ease,box-shadow .2s ease}
    .settings-option:hover{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .settings-option:focus-within{outline:2px solid var(--accent);outline-offset:2px}
    .settings-option input{margin:0;accent-color:var(--accent)}
    .settings-option span{flex:1}

    /* ===== Encabezados de sección ===== */
    .section-head{font-weight:700;margin-bottom:8px;color:var(--ink);text-shadow:0 10px 24px color-mix(in srgb,var(--text) 45%,transparent)}

    /* ===== Tokens de tema ===== */
    .sidebar-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:16px}
    .sidebar-list li{display:flex;flex-direction:column;gap:8px;color:var(--ink)}
    .sidebar-list li button.btn{align-self:flex-start}
    .auth-controls{gap:12px}
    .auth-user{position:relative;display:flex;flex-direction:column;gap:10px}
    .auth-avatar-btn{display:inline-flex;align-items:center;gap:10px;padding:6px 12px;border-radius:999px;border:1px solid var(--ghost-border);background:var(--ghost);color:var(--ink);font-weight:600;cursor:pointer;transition:background-color .2s ease,border-color .2s ease,box-shadow .2s ease}
    .auth-avatar-btn:hover{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border)}
    .auth-avatar-btn:active{background:var(--ghost-active-bg);border-color:var(--ghost-active-border)}
    .auth-avatar-btn:focus-visible{outline:2px solid var(--action-focus-outline);outline-offset:2px}
    .auth-avatar{--avatar-color:var(--accent);width:34px;height:34px;border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:16px;color:var(--card);background:var(--avatar-color);text-transform:uppercase}
    .auth-name{max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;color:var(--ink)}
    .auth-config-panel{position:absolute;top:calc(100% + 6px);left:0;display:flex;flex-direction:column;gap:10px;background:var(--panel-grad);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px;width:100%;z-index:60}
    .auth-config-panel .btn{width:100%;justify-content:center}
    .sidebar input,.sidebar select{border:1px solid var(--input-border);background:var(--input-bg);color:var(--ink)}
    .sidebar-search{position:relative;display:flex;align-items:center}
    .sidebar-search-icon{position:absolute;left:14px;display:flex;align-items:center;justify-content:center;color:var(--muted);pointer-events:none;font-size:16px}
    .sidebar-search input{padding-left:42px}
    .sidebar-search:focus-within .sidebar-search-icon{color:var(--ink)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .menu-item[aria-checked="true"]{background:var(--ghost);border:1px solid var(--ghost-border);font-weight:600}

    @media(max-width:1024px){
      #Header,#BarraServicio,#AppGrid{width:min(100%,96vw)}
    }
    @media(max-height:780px){
      .layout-shell{align-content:stretch;justify-items:stretch}
    }
    @media(max-width:960px){ body.sidebar-expanded{padding-left:0} }
    @media(max-width:820px){
      #AppGrid{gap:20px;padding-bottom:60px}
      .side-card{padding:24px}
    }
    @media(max-width:768px){
      .sidebar{box-shadow:0 0 0 transparent}
      .sidebar.pinned,.sidebar.peek{box-shadow:var(--shadow)}
      body.sidebar-expanded .sidebar-launcher{left:20px}
      .side-card .actions{flex-direction:column}
      .side-card .actions .btn{width:100%}
    }
    @media(max-width:640px){
      .form,.side-card{padding:22px 18px}
      .actions{flex-direction:column}
      .actions .btn{width:100%;flex:1 1 auto}
      .center{gap:12px}
      .center .label{width:100%;text-align:center}
      .center > *{flex:1 1 100%;min-width:0}
      .center button{flex:1 1 48%}
      .center select{min-width:0}
      #AppGrid{padding-bottom:48px}
      .view-nav{flex-direction:column;align-items:stretch}
      .view-nav .btn{width:100%}
      .view-note{margin:24px auto 10px}
    }
    @media(max-width:520px){
      .sidebar-launcher{width:48px;height:48px}
      .sidebar{width:min(280px,92vw)}
      .form,.side-card{padding:20px 16px}
      .table-card{border-radius:18px}
    }
  </style>
</head>
<body>
  <section class="landing" data-landing>
    <div class="landing-hero">
      <div class="landing-logo" aria-hidden="true">🪄</div>
      <p class="landing-pill">Asistente para negocios digitales</p>
      <h1 class="landing-title">Administra tus clientes con ZYLO</h1>
      <p class="landing-subtitle">Conecta tus servicios, centraliza credenciales y ofrece una experiencia premium desde un solo panel.</p>
      <div class="landing-actions" data-landing-actions>
        <button type="button" class="btn primary" id="landingStart">Empezar ahora</button>
        <button type="button" class="btn ghost" id="landingLogin">Ya tengo una cuenta</button>
      </div>
    </div>

    <div class="landing-panels">
      <article class="landing-panel" data-landing-view="home" aria-hidden="false">
        <h2>Elige cómo continuar</h2>
        <p>Configura una cuenta nueva o ingresa con tus credenciales existentes.</p>
      </article>

      <article class="landing-panel" data-landing-view="signup" aria-hidden="true" hidden>
        <header>
          <h2>Crea tu cuenta</h2>
          <p>Registra tus datos para sincronizar tus servicios. Podrás editarlo todo luego.</p>
        </header>
        <form id="signupForm" class="landing-form">
          <div class="row">
            <label for="signupName">Nombre para mostrar</label>
            <input id="signupName" type="text" autocomplete="name" placeholder="Tu nombre o marca" required>
          </div>
          <div class="row">
            <label for="signupEmail">Correo</label>
            <input id="signupEmail" type="email" autocomplete="email" placeholder="tucorreo@empresa.com" required>
          </div>
          <div class="row">
            <label for="signupPass">Crea una contraseña</label>
            <input id="signupPass" type="password" autocomplete="new-password" placeholder="Mínimo 8 caracteres" minlength="8" required>
          </div>
          <div class="row">
            <label for="signupConfirm">Confirma tu contraseña</label>
            <input id="signupConfirm" type="password" autocomplete="new-password" placeholder="Repite tu contraseña" minlength="8" required>
          </div>
          <div class="landing-errors" id="signupError" role="alert"></div>
          <div class="actions">
            <button type="submit" class="btn primary">Crear cuenta</button>
            <button type="button" class="btn ghost" data-landing-back>Volver</button>
          </div>
        </form>
      </article>

      <article class="landing-panel" data-landing-view="login" aria-hidden="true" hidden>
        <header>
          <h2>Inicia sesión</h2>
          <p>Usa tu correo y contraseña registrados para entrar al dashboard.</p>
        </header>
        <form id="loginForm" class="landing-form">
          <div class="row">
            <label for="authEmail">Correo</label>
            <input id="authEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" required>
          </div>
          <div class="row">
            <label for="authPass">Contraseña</label>
            <div class="pin-wrap">
              <input id="authPass" type="password" placeholder="••••••••" autocomplete="current-password" required>
              <button type="button" class="eye" id="toggleAuthPass" aria-label="Mostrar/ocultar contraseña">👁</button>
            </div>
          </div>
          <div class="landing-errors" id="authError" role="alert"></div>
          <div class="actions">
            <button type="submit" class="btn primary" id="btnAuthSubmit">Entrar</button>
            <button type="button" class="btn ghost" data-landing-back>Volver</button>
          </div>
          <button id="btnForgot" class="linklike" type="button">¿Olvidaste tu contraseña?</button>
          <div class="landing-google">
            <div id="googleButton"></div>
            <p class="small" data-google-feedback></p>
          </div>
        </form>
      </article>
    </div>
  </section>

  <div data-dashboard hidden>
  <button type="button" id="sidebarLauncher" class="sidebar-launcher" aria-controls="sidebar" aria-label="Abrir navegación" aria-expanded="false">☰</button>

  <aside class="sidebar" id="sidebar" data-pinned="false" aria-hidden="true">
    <div class="sidebar-content">
      <nav aria-label="Controles principales">
        <ul class="sidebar-list">
          <li>
            <div class="sidebar-search">
              <span class="sidebar-search-icon" aria-hidden="true">🔍</span>
              <label class="sr-only" for="q">Buscar</label>
              <input id="q" placeholder="Buscar por nombre, email o servicio…"/>
            </div>
          </li>
          <li>
            <label class="label" for="filterEstado">Estado</label>
            <select id="filterEstado">
              <option value="">Todos</option>
              <option value="vigente">Vigentes</option>
              <option value="pronto">Por vencer (≤7 días)</option>
              <option value="vencida">Vencidas</option>
            </select>
          </li>
          <li class="auth-controls">
            <button class="btn ghost label" id="btnAuthOpen">Acceder</button>
            <div class="auth-user" id="auth-user" hidden aria-hidden="true">
              <button type="button" class="auth-avatar-btn" id="userTrigger" role="button" aria-haspopup="menu" aria-controls="userMenu" aria-expanded="false">
                <span class="auth-avatar" id="userAvatar" aria-hidden="true">U</span>
                <span class="auth-name" id="userDisplayName"></span>
                <span class="sr-only">Abrir configuración</span>
              </button>
              <div class="auth-config-panel hidden" id="userMenu" role="menu" aria-label="Configuración de usuario">
                <button class="btn ghost label" id="btnUserSettings" type="button" role="menuitem">Configuración</button>
                <button class="btn ghost label" id="btnLogout" type="button" role="menuitem">Cerrar</button>
              </div>
            </div>
          </li>
          <li>
            <button class="btn ghost label" id="emailLinkerOpen">Enlazar correo</button>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <div class="layout-shell">
    <header id="Header" class="scroll-fade">
      <span class="pill">Gestor de clientes online</span>
      <h1 class="hero-brand">ZYLO</h1>
    </header>

    <section id="BarraServicio" class="center scroll-fade">
      <div class="service-group">
        <label class="label service-label" for="servicio">SERVICIO</label>
        <select id="servicio" style="max-width:260px"></select>
      </div>
      <button id="btnAgregarServicio" class="addserv" aria-label="Agregar servicio" title="Agregar servicio">+</button>
      <button id="btnEliminarServicio" class="addserv remove" aria-label="Eliminar servicio" title="Eliminar servicio">−</button>
    </section>

    <main id="AppMain">
      <section id="vistaFormulario" class="app-view is-active" aria-hidden="false">
        <div class="view-container">
          <p class="view-note">Esta pantalla corresponde a la primera vista: captura los datos del cliente y, al pulsar “Agregar”, se abrirá automáticamente la lista de clientes registrados.</p>
          <div class="view-nav">
            <button type="button" class="btn ghost" id="btnVerClientes">Ver clientes registrados</button>
          </div>
        </div>
        <div id="AppGrid">
          <section id="Formulario" class="form scroll-fade">
            <div class="form-grid">
              <div class="row">
                <label for="nombre">Nombre</label>
                <input id="nombre" placeholder="Escribe"/>
              </div>

            <!-- EMAIL con dropdown contextual por servicio -->
            <div class="row suggestion-source">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="ej: cliente@mail.com" aria-expanded="false" aria-controls="emailSuggestionDropdown" />
              <button class="email-toggle" id="emailDropdownToggle" type="button" aria-label="Mostrar correos guardados">▾</button>
              <div id="emailSuggestionDropdown" class="suggestion-dropdown" role="listbox" aria-hidden="true"></div>
            </div>

            <div class="row phone-row">
              <label for="telefono">Teléfono</label>
              <div class="phone-control" id="phoneControl">
                <button type="button" class="phone-country" id="phoneCountry" aria-haspopup="listbox" aria-expanded="false" aria-label="Selecciona el país">
                  <span class="phone-flag" id="phoneFlag" aria-hidden="true">🇵🇪</span>
                  <span class="phone-code" id="phoneDialLabel">+51</span>
                  <span class="phone-caret" aria-hidden="true">▾</span>
                </button>
                <input id="telefono" type="tel" placeholder="Introduce el número" autocomplete="tel" inputmode="tel" aria-describedby="phoneDialLabel" />
                <div class="phone-dropdown" id="phoneDropdown" role="listbox" aria-label="Selecciona el país" aria-hidden="true"></div>
              </div>
            </div>
            <div class="row">
              <label for="inicio">Fecha</label>
              <input id="inicio" type="date" />
            </div>
            <div class="row">
              <label for="vence">Vence</label>
              <input id="vence" type="date" />
            </div>
            <div class="row">
              <label for="pin">PIN</label>
              <div class="pin-wrap">
                <input id="pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="••••" />
                <button type="button" class="eye" id="togglePin" aria-label="Mostrar/ocultar PIN">👁</button>
              </div>
            </div>
            <div class="row">
              <label for="categoria">Categoría</label>
              <select id="categoria">
                <option value="">Selecciona una opción</option>
                <option>Premium</option>
                <option>Estándar</option>
                <option>Básico</option>
              </select>
            </div>
            <div class="row span-2">
              <label for="notas">Notas</label>
              <textarea id="notas" placeholder="Plan, precio, usuario, etc."></textarea>
            </div>
          </div>
        </section>

        <aside id="AccionesRapidas" class="side-card scroll-fade">
          <h2>Acciones rápidas</h2>
          <p>Guarda el nuevo cliente o limpia el formulario antes de continuar.</p>
          <div class="actions">
            <button class="btn primary" id="btnGuardar">Agregar</button>
            <button class="btn ghost" id="btnLimpiar">Limpiar</button>
          </div>
          <div class="small" id="msg"></div>
        </aside>
      </div>
    </section>

    <section id="vistaClientes" class="app-view" aria-hidden="true" hidden>
      <div class="view-container">
        <p class="view-note">Segunda vista: aquí puedes consultar y gestionar a los clientes registrados. Usa el siguiente botón para volver al formulario y agregar un nuevo registro.</p>
        <div class="view-nav">
          <button type="button" class="btn ghost" id="btnVolverFormulario">← Volver al formulario</button>
        </div>
        <section id="TablaClientes" class="table-section scroll-fade" tabindex="-1">
          <div class="table-header">
            <h2 id="clientesTitulo">Clientes registrados</h2>
            <p>Consulta el listado completo y gestiona cada registro.</p>
          </div>
          <div class="table-card">
            <div class="table-scroll" role="region" aria-labelledby="clientesTitulo" tabindex="0">
              <table id="tabla">
                <thead>
                  <tr>
                    <th>Nombre</th><th>Email</th><th>Servicio</th>
                    <th>Inicio</th><th>Vence</th><th>Estado</th><th>Días</th><th><span class="sr-only">Acciones</span></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </section>
    </main>
  </div>
  <!-- ===== Modal Configuración de usuario ===== -->
  <div id="settingsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="settingsModalTitle">
      <header>
        <strong id="settingsModalTitle">Configuración</strong>
        <button class="btn ghost" id="btnSettingsClose" type="button">Cerrar</button>
      </header>
      <div class="body">
        <p class="settings-description">Personaliza tu experiencia ajustando las preferencias disponibles.</p>
        <fieldset class="settings-fieldset">
          <legend>Tema de la aplicación</legend>
          <div class="settings-group">
            <label class="settings-option">
              <input type="radio" name="settingsTheme" value="system">
              <span>Usar el modo del sistema</span>
            </label>
            <label class="settings-option">
              <input type="radio" name="settingsTheme" value="light">
              <span>Tema claro</span>
            </label>
            <label class="settings-option">
              <input type="radio" name="settingsTheme" value="dark">
              <span>Tema oscuro</span>
            </label>
          </div>
        </fieldset>
      </div>
    </div>
  </div>

  <!-- ===== Modal Enlazar correo ===== -->
  <div id="emailLinkerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal email-linker-modal" role="dialog" aria-labelledby="emailLinkerTitle">
      <header>
        <strong id="emailLinkerTitle">Enlazar correo</strong>
        <button class="btn ghost" id="emailLinkerClose" type="button">Cerrar</button>
      </header>
      <div class="body">
        <div class="email-linker-fields">
          <div class="row">
            <label for="emailLinkerService">Servicio</label>
            <select id="emailLinkerService"></select>
          </div>
          <div class="row email-linker-input">
            <div>
              <label for="emailLinkerEmail">Email</label>
              <input id="emailLinkerEmail" type="email" placeholder="correo@ejemplo.com" autocomplete="off">
            </div>
            <button class="btn primary" id="emailLinkerAdd" type="button">Añadir</button>
          </div>
          <p class="email-linker-error" id="emailLinkerError" role="alert"></p>
        </div>
        <div class="email-linker-list" id="emailLinkerList" role="list"></div>
      </div>
    </div>
  </div>

</div>

<script type="module">
import { auth, db as firestore, persistenceReady } from './firebaseConfig.js';
import {
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  sendPasswordResetEmail,
  signOut,
  sendEmailVerification,
  updateProfile
} from 'firebase/auth';
import {
  collection,
  addDoc,
  doc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  serverTimestamp,
  setDoc,
  getDoc
} from 'firebase/firestore';

const persistenceReadyForInit = persistenceReady.catch(error => {
  if (error?.code === 'failed-precondition') {
    console.warn('La persistencia de Firestore solo puede habilitarse en una pestaña a la vez');
    toast('La persistencia de Firestore solo puede habilitarse en una pestaña a la vez');
  } else if (error?.code === 'unimplemented') {
    console.info('IndexedDB persistence unavailable: browser does not support it.');
    toast('Tu navegador no soporta el modo sin conexión de Firestore.');
  } else if (error) {
    console.error('No se pudo activar la persistencia de Firestore', error);
    toast('No se pudo activar el modo sin conexión.');
  }
});

const THEME_PREFERENCE_KEY = 'app_theme_preference';
const VALID_THEME_PREFERENCES = new Set(['system','light','dark']);

function readStoredThemePreference(){
  try{
    const stored = localStorage.getItem(THEME_PREFERENCE_KEY);
    if(stored && VALID_THEME_PREFERENCES.has(stored)){
      return stored;
    }
  }catch(error){
    console.warn('No se pudo leer la preferencia de tema almacenada.', error);
  }
  return 'system';
}

function applyThemePreference(mode){
  const root = document.documentElement;
  if(!root) return;
  if(mode==='light' || mode==='dark'){
    root.dataset.theme = mode;
  }else{
    delete root.dataset.theme;
  }
}

let currentThemePreference = readStoredThemePreference();
const datasetThemePreference = document.documentElement?.dataset?.theme;
if(datasetThemePreference && VALID_THEME_PREFERENCES.has(datasetThemePreference)){
  currentThemePreference = datasetThemePreference;
}
applyThemePreference(currentThemePreference);

function persistThemePreference(mode){
  try{
    localStorage.setItem(THEME_PREFERENCE_KEY, mode);
  }catch(error){
    console.warn('No se pudo guardar la preferencia de tema.', error);
  }
}

let settingsThemeOptions = [];
let settingsReturnFocus = null;

function updateThemeControls(pref = currentThemePreference){
  if(!Array.isArray(settingsThemeOptions) || !settingsThemeOptions.length) return;
  settingsThemeOptions.forEach((input)=>{
    input.checked = input.value === pref;
  });
}

function setThemePreference(mode){
  if(!VALID_THEME_PREFERENCES.has(mode)) return;
  currentThemePreference = mode;
  applyThemePreference(mode);
  persistThemePreference(mode);
  updateThemeControls(mode);
}

/* ===== helpers y refs ===== */
const $=s=>document.querySelector(s);
const tbody=$('#tabla tbody');
const f={nombre:$('#nombre'),email:$('#email'),telefono:$('#telefono'),
servicio:$('#servicio'),inicio:$('#inicio'),vence:$('#vence'),notas:$('#notas'),
categoria:$('#categoria'), pin:$('#pin')};
const q=$('#q'), filterEstado=$('#filterEstado'), msg=$('#msg');
const sidebar=document.getElementById('sidebar');
const sidebarLauncher=document.getElementById('sidebarLauncher');
const vistaFormulario=document.getElementById('vistaFormulario');
const vistaClientes=document.getElementById('vistaClientes');
const btnVerClientes=document.getElementById('btnVerClientes');
const btnVolverFormulario=document.getElementById('btnVolverFormulario');
const tablaSection=document.getElementById('TablaClientes');
const formSection=document.getElementById('Formulario');
const landing=document.querySelector('[data-landing]');
const dashboardContainer=document.querySelector('[data-dashboard]');
const landingPanels=document.querySelectorAll('[data-landing-view]');
const landingStartBtn=document.getElementById('landingStart');
const landingLoginBtn=document.getElementById('landingLogin');
const landingBackButtons=document.querySelectorAll('[data-landing-back]');
const signupForm=document.getElementById('signupForm');
const signupNameEl=document.getElementById('signupName');
const signupEmailEl=document.getElementById('signupEmail');
const signupPassEl=document.getElementById('signupPass');
const signupConfirmEl=document.getElementById('signupConfirm');
const signupErrorEl=document.getElementById('signupError');
const loginForm=document.getElementById('loginForm');
const googleFeedbackEl=document.querySelector('[data-google-feedback]');

function hashString(value=''){
  let hash=0;
  for(let i=0;i<value.length;i+=1){
    hash=(hash<<5)-hash+value.charCodeAt(i);
    hash|=0;
  }
  return Math.abs(hash);
}
function generateAvatarColor(seed){
  const hash=hashString(seed||'default');
  const hue=hash%360;
  return `hsl(${hue}, 65%, 55%)`;
}
const AUTH_DISPLAY_NAME_LIMIT = 16;
function truncateDisplayName(name, limit = AUTH_DISPLAY_NAME_LIMIT){
  const clean = String(name || '').trim();
  if(!clean) return '';
  if(clean.length <= limit) return clean;
  return `${clean.slice(0, Math.max(1, limit - 1)).trimEnd()}…`;
}
function getDefaultLanguage(){
  if(typeof navigator!=='undefined'){
    return navigator.language || navigator.userLanguage || 'es';
  }
  return 'es';
}
function getCurrentThemePreference(){
  const themeAttr=document.documentElement?.dataset?.theme;
  if(themeAttr&&themeAttr.trim()){ return themeAttr.trim(); }
  return 'system';
}
async function syncUserProfile(user, { displayName }={}){
  if(!user) return null;
  const requestedName=(displayName||'').trim();
  let finalDisplayName=requestedName||(user.displayName||'').trim();
  if(!finalDisplayName){
    finalDisplayName=user.email?user.email.split('@')[0]:'Usuario';
  }
  const shouldUpdateProfile=finalDisplayName&&user.displayName!==finalDisplayName;
  if(shouldUpdateProfile){
    try{
      await updateProfile(user, { displayName: finalDisplayName });
    }catch(error){
      console.error('No se pudo actualizar el perfil del usuario', error);
    }
  }
  const avatarSeed=user.uid||user.email||finalDisplayName;
  const avatarColor=generateAvatarColor(String(avatarSeed));
  const language=getDefaultLanguage();
  const theme=getCurrentThemePreference();
  const userDocRef=doc(firestore, 'users', user.uid);
  const payload={
    displayName: finalDisplayName,
    email: user.email||'',
    avatarColor,
    language,
    theme,
    updatedAt: serverTimestamp()
  };
  await setDoc(userDocRef, payload, { merge: true });
  return payload;
}

function setLandingView(view){
  landingPanels.forEach(panel=>{
    const isActive=panel.dataset.landingView===view;
    panel.hidden=!isActive;
    panel.setAttribute('aria-hidden',String(!isActive));
  });
  if(view==='login'){
    setTimeout(()=>authEmailEl?.focus(),0);
  }else if(view==='signup'){
    setTimeout(()=>signupNameEl?.focus(),0);
  }
}

function showLanding(view='home'){
  if(landing){ landing.hidden=false; landing.removeAttribute('hidden'); }
  if(dashboardContainer){ dashboardContainer.hidden=true; }
  setLandingView(view);
}

function hideLanding(){
  if(landing){ landing.hidden=true; }
  if(dashboardContainer){ dashboardContainer.hidden=false; }
}

landingStartBtn?.addEventListener('click',()=>{
  showLanding('signup');
});

landingLoginBtn?.addEventListener('click',event=>{
  event.preventDefault();
  showLanding('login');
});

landingBackButtons.forEach(btn=>{
  btn.addEventListener('click',()=>setLandingView('home'));
});

let editId=null;
const views={form:vistaFormulario,clientes:vistaClientes};

function showView(target,{skipFocus=false}={}){
  if(!views[target]) return;
  Object.entries(views).forEach(([name,el])=>{
    if(!el) return;
    const isActive=name===target;
    el.classList.toggle('is-active',isActive);
    if(isActive){ el.removeAttribute('hidden'); }
    else{ el.setAttribute('hidden',''); }
    el.setAttribute('aria-hidden',isActive?'false':'true');
  });
  if(skipFocus) return;
  window.requestAnimationFrame(()=>{
    if(target==='clientes'){
      tablaSection?.scrollIntoView({ behavior:'smooth', block:'start' });
      const region=tablaSection?.querySelector('.table-scroll');
      region?.focus({ preventScroll:true });
    }else{
      formSection?.scrollIntoView({ behavior:'smooth', block:'start' });
      f.nombre?.focus();
    }
  });
}

btnVerClientes?.addEventListener('click',()=>showView('clientes'));
btnVolverFormulario?.addEventListener('click',()=>showView('form'));
showView('form',{skipFocus:true});

/* ===== Teléfono con selector de país ===== */
const phoneControl=$('#phoneControl');
const phoneCountryButton=document.getElementById('phoneCountry');
const phoneDropdown=document.getElementById('phoneDropdown');
const phoneFlag=document.getElementById('phoneFlag');
const phoneDialLabel=document.getElementById('phoneDialLabel');
const phoneInput=f.telefono;

const phoneCountriesRaw=[
  {name:'Afganistán',dial:'+93',flag:'🇦🇫'},
  {name:'Albania',dial:'+355',flag:'🇦🇱'},
  {name:'Alemania',dial:'+49',flag:'🇩🇪'},
  {name:'Andorra',dial:'+376',flag:'🇦🇩'},
  {name:'Angola',dial:'+244',flag:'🇦🇴'},
  {name:'Anguila',dial:'+1 264',flag:'🇦🇮'},
  {name:'Antigua y Barbuda',dial:'+1 268',flag:'🇦🇬'},
  {name:'Arabia Saudí',dial:'+966',flag:'🇸🇦'},
  {name:'Argelia',dial:'+213',flag:'🇩🇿'},
  {name:'Argentina',dial:'+54',flag:'🇦🇷'},
  {name:'Armenia',dial:'+374',flag:'🇦🇲'},
  {name:'Aruba',dial:'+297',flag:'🇦🇼'},
  {name:'Australia',dial:'+61',flag:'🇦🇺'},
  {name:'Austria',dial:'+43',flag:'🇦🇹'},
  {name:'Azerbaiyán',dial:'+994',flag:'🇦🇿'},
  {name:'Bahamas',dial:'+1 242',flag:'🇧🇸'},
  {name:'Bangladés',dial:'+880',flag:'🇧🇩'},
  {name:'Baréin',dial:'+973',flag:'🇧🇭'},
  {name:'Barbados',dial:'+1 246',flag:'🇧🇧'},
  {name:'Bélgica',dial:'+32',flag:'🇧🇪'},
  {name:'Belice',dial:'+501',flag:'🇧🇿'},
  {name:'Benín',dial:'+229',flag:'🇧🇯'},
  {name:'Bermudas',dial:'+1 441',flag:'🇧🇲'},
  {name:'Bolivia',dial:'+591',flag:'🇧🇴'},
  {name:'Bosnia y Herzegovina',dial:'+387',flag:'🇧🇦'},
  {name:'Botsuana',dial:'+267',flag:'🇧🇼'},
  {name:'Brasil',dial:'+55',flag:'🇧🇷'},
  {name:'Canadá',dial:'+1',flag:'🇨🇦'},
  {name:'Chile',dial:'+56',flag:'🇨🇱'},
  {name:'China',dial:'+86',flag:'🇨🇳'},
  {name:'Colombia',dial:'+57',flag:'🇨🇴'},
  {name:'Costa Rica',dial:'+506',flag:'🇨🇷'},
  {name:'Cuba',dial:'+53',flag:'🇨🇺'},
  {name:'Ecuador',dial:'+593',flag:'🇪🇨'},
  {name:'Egipto',dial:'+20',flag:'🇪🇬'},
  {name:'El Salvador',dial:'+503',flag:'🇸🇻'},
  {name:'España',dial:'+34',flag:'🇪🇸'},
  {name:'Estados Unidos',dial:'+1',flag:'🇺🇸'},
  {name:'Francia',dial:'+33',flag:'🇫🇷'},
  {name:'Grecia',dial:'+30',flag:'🇬🇷'},
  {name:'Guatemala',dial:'+502',flag:'🇬🇹'},
  {name:'Honduras',dial:'+504',flag:'🇭🇳'},
  {name:'India',dial:'+91',flag:'🇮🇳'},
  {name:'Italia',dial:'+39',flag:'🇮🇹'},
  {name:'Japón',dial:'+81',flag:'🇯🇵'},
  {name:'México',dial:'+52',flag:'🇲🇽'},
  {name:'Panamá',dial:'+507',flag:'🇵🇦'},
  {name:'Paraguay',dial:'+595',flag:'🇵🇾'},
  {name:'Perú',dial:'+51',flag:'🇵🇪'},
  {name:'Portugal',dial:'+351',flag:'🇵🇹'},
  {name:'Reino Unido',dial:'+44',flag:'🇬🇧'},
  {name:'República Dominicana',dial:'+1 809',flag:'🇩🇴'},
  {name:'Uruguay',dial:'+598',flag:'🇺🇾'},
  {name:'Venezuela',dial:'+58',flag:'🇻🇪'}
];
const phoneCountries=phoneCountriesRaw.map(c=>({
  ...c,
  dialDigits:(c.dial||'').replace(/\D+/g,'')
})).sort((a,b)=>a.name.localeCompare(b.name,'es',{sensitivity:'base'}));
const phoneCountriesByDialLength=phoneCountries.slice().sort((a,b)=>b.dialDigits.length-a.dialDigits.length);
const defaultPhoneCountry=phoneCountries.find(c=>c.dialDigits==='51')||phoneCountries[0]||null;
let selectedPhoneCountry=defaultPhoneCountry;

function renderPhoneCountryOptions(){
  if(!phoneDropdown) return;
  phoneDropdown.innerHTML=phoneCountries.map(c=>`
    <button type="button" class="phone-option" role="option" data-dial-digits="${c.dialDigits}">
      <span class="phone-option-flag" aria-hidden="true">${c.flag}</span>
      <span class="phone-option-meta">
        <span class="phone-option-name">${c.name}</span>
        <span class="phone-option-code">${c.dial}</span>
      </span>
    </button>
  `).join('');
}
function resolvePhoneCountry(target){
  if(!target) return null;
  if(typeof target==='object' && target.dialDigits) return target;
  const digits=String(target).replace(/\D+/g,'');
  if(!digits) return null;
  return phoneCountries.find(c=>c.dialDigits===digits)||null;
}
function updatePhoneButtonAccessibility(country){
  if(!phoneCountryButton||!country) return;
  phoneCountryButton.setAttribute('aria-label',`Código de país: ${country.name} (${country.dial})`);
  phoneCountryButton.dataset.dialDigits=country.dialDigits;
}
function setSelectedPhoneCountry(target,{resetInput=false}={}){
  const country=resolvePhoneCountry(target)||defaultPhoneCountry||null;
  if(!country) return;
  selectedPhoneCountry=country;
  if(phoneFlag) phoneFlag.textContent=country.flag;
  if(phoneDialLabel) phoneDialLabel.textContent=country.dial;
  updatePhoneButtonAccessibility(country);
  if(phoneDropdown){
    phoneDropdown.querySelectorAll('.phone-option').forEach(btn=>{
      btn.setAttribute('aria-selected',btn.dataset.dialDigits===country.dialDigits?'true':'false');
    });
  }
  if(resetInput && phoneInput) phoneInput.value='';
}
function formatPhoneDisplay(digits){
  if(!digits) return '';
  return digits.replace(/(\d{3})(?=\d)/g,'$1 ').trim();
}
function parsePhoneValue(raw){
  const digits=(raw||'').toString().replace(/\D+/g,'');
  if(!digits) return {country:null,number:''};
  const match=phoneCountriesByDialLength.find(c=>digits.startsWith(c.dialDigits));
  if(match) return {country:match,number:digits.slice(match.dialDigits.length)};
  return {country:null,number:digits};
}
function getPhoneValue(){
  if(!phoneInput||!selectedPhoneCountry) return '';
  const digits=phoneInput.value.replace(/\D+/g,'');
  if(!digits) return '';
  const formatted=formatPhoneDisplay(digits);
  return `${selectedPhoneCountry.dial} ${formatted}`.trim();
}
function applyPhoneValue(raw){
  const {country,number}=parsePhoneValue(raw||'');
  setSelectedPhoneCountry(country||defaultPhoneCountry,{resetInput:true});
  if(phoneInput) phoneInput.value=formatPhoneDisplay(number);
}
function resetPhoneInput(){
  setSelectedPhoneCountry(defaultPhoneCountry,{resetInput:true});
}
function setPhoneDropdownOpen(open){
  if(!phoneDropdown||!phoneCountryButton) return;
  if(open){
    phoneDropdown.classList.add('open');
    phoneDropdown.setAttribute('aria-hidden','false');
    phoneCountryButton.setAttribute('aria-expanded','true');
    const active=phoneDropdown.querySelector('.phone-option[aria-selected="true"]');
    active?.scrollIntoView({block:'nearest'});
  }else{
    phoneDropdown.classList.remove('open');
    phoneDropdown.setAttribute('aria-hidden','true');
    phoneCountryButton.setAttribute('aria-expanded','false');
  }
}

renderPhoneCountryOptions();
if(defaultPhoneCountry) setSelectedPhoneCountry(defaultPhoneCountry,{resetInput:true});
setPhoneDropdownOpen(false);

phoneInput?.addEventListener('input',()=>{
  const digits=phoneInput.value.replace(/\D+/g,'');
  phoneInput.value=formatPhoneDisplay(digits);
});
phoneCountryButton?.addEventListener('click',()=>{
  const isOpen=phoneDropdown?.classList.contains('open');
  setPhoneDropdownOpen(!isOpen);
});
phoneDropdown?.addEventListener('click',e=>{
  const option=e.target.closest('.phone-option');
  if(!option) return;
  const digits=option.dataset.dialDigits;
  const country=resolvePhoneCountry(digits);
  setSelectedPhoneCountry(country);
  setPhoneDropdownOpen(false);
  phoneInput?.focus();
});
document.addEventListener('click',e=>{
  if(!phoneControl) return;
  if(phoneControl.contains(e.target)) return;
  setPhoneDropdownOpen(false);
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') setPhoneDropdownOpen(false);
});


/* ===== Dropdown EMAIL (form principal) ===== */
const emailSuggestionDropdown = document.getElementById('emailSuggestionDropdown');
const emailDropdownToggle = document.getElementById('emailDropdownToggle');
let emailSuggestionCache=[];
let filteredEmailSuggestions=[];
let activeEmailSuggestionIndex=-1;
let hideEmailSuggestionTimeout=null;

/* ===== Animaciones scroll ===== */
function setupScrollFade(){
  const targets = Array.from(document.querySelectorAll('.scroll-fade'));
  if(!targets.length) return;

  document.body.classList.add('scroll-animations-ready');

  if(!('IntersectionObserver' in window)){
    targets.forEach(el=> el.classList.add('is-visible'));
    return;
  }

  const reduceMotionQuery = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : null;
  let observer = null;

  const ensureObserver = ()=>{
    if(observer) return;
    observer = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          entry.target.classList.add('is-visible');
        }else{
          entry.target.classList.remove('is-visible');
        }
      });
    }, { threshold:0.18, rootMargin:'0px 0px -12% 0px' });
    targets.forEach(el=>{
      el.classList.remove('is-visible');
      observer.observe(el);
    });
  };

  const teardownObserver = ()=>{
    if(observer){ observer.disconnect(); observer=null; }
    targets.forEach(el=> el.classList.add('is-visible'));
  };

  const evaluate = ()=>{
    if(reduceMotionQuery && reduceMotionQuery.matches){
      teardownObserver();
    }else{
      ensureObserver();
      requestAnimationFrame(()=>{
        targets.forEach(el=>{
          const rect = el.getBoundingClientRect();
          const inView = rect.top < window.innerHeight && rect.bottom > 0;
          if(inView) el.classList.add('is-visible');
        });
      });
    }
  };

  evaluate();
  if(reduceMotionQuery){
    const listener = () => evaluate();
    if(reduceMotionQuery.addEventListener){ reduceMotionQuery.addEventListener('change', listener); }
    else if(reduceMotionQuery.addListener){ reduceMotionQuery.addListener(listener); }
  }
}
setupScrollFade();

function toast(t){ msg.textContent=t; setTimeout(()=>msg.textContent='',2200); }
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;' }[m]))}
function fmt(iso){return iso? new Date(iso+'T00:00:00').toLocaleDateString(): '-'}

/* ===== sidebar responsive ===== */
const sidebarMobileQuery=window.matchMedia? window.matchMedia('(max-width: 768px)') : { matches:false };
function isMobileSidebar(){ return sidebarMobileQuery.matches; }
function syncSidebarResponsiveState(){
  if(!sidebar) return;
  const pinned = sidebar.dataset.pinned === 'true';
  sidebar.classList.toggle('pinned', pinned);
  const isVisible = pinned || (!isMobileSidebar() && sidebar.classList.contains('peek'));
  sidebar.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
  sidebarLauncher?.setAttribute('aria-expanded', pinned ? 'true' : 'false');
  sidebarLauncher.textContent = pinned ? '✕' : '☰';
  sidebarLauncher.setAttribute('aria-label', pinned ? 'Cerrar navegación' : 'Abrir navegación');
  sidebarLauncher.classList.toggle('is-open', pinned);
  if(isMobileSidebar()){
    document.body.classList.remove('sidebar-expanded');
  }else{
    document.body.classList.toggle('sidebar-expanded', pinned);
  }
}
function setSidebarPinned(pinned){
  if(!sidebar) return;
  sidebar.dataset.pinned = String(pinned);
  if(!pinned){ sidebar.classList.remove('peek'); }
  syncSidebarResponsiveState();
}
function expandSidebarIfNeeded(){
  if(!sidebar || isMobileSidebar()) return;
  if(sidebar.dataset.pinned === 'true') return;
  sidebar.classList.add('peek'); sidebar.setAttribute('aria-hidden','false');
}
function collapseSidebarIfNeeded(){
  if(!sidebar) return;
  if(sidebar.dataset.pinned === 'true') return;
  sidebar.classList.remove('peek'); sidebar.setAttribute('aria-hidden','true');
}
syncSidebarResponsiveState();
sidebarLauncher?.addEventListener('click', ()=> setSidebarPinned(sidebar.dataset.pinned !== 'true'));
sidebar?.addEventListener('mouseenter', expandSidebarIfNeeded);
sidebar?.addEventListener('mouseleave', collapseSidebarIfNeeded);
sidebar?.addEventListener('focusin', expandSidebarIfNeeded);
sidebar?.addEventListener('focusout', (e)=>{ if(!sidebar.contains(e.relatedTarget)) collapseSidebarIfNeeded(); });
if(sidebarMobileQuery.addEventListener){ sidebarMobileQuery.addEventListener('change', ()=>{ syncSidebarResponsiveState(); collapseSidebarIfNeeded(); }); }

/* ===== fechas & estado ===== */
function diasRestantes(iso){
  if(!iso) return null; const h=new Date();h.setHours(0,0,0,0);
  const d=new Date(iso); d.setHours(0,0,0,0);
  return Math.round((d-h)/(1000*60*60*24));
}
function estadoDe(vence){
  if(!vence) return ''; const d=diasRestantes(vence);
  if(d<0) return 'vencida'; if(d<=7) return 'pronto'; return 'vigente';
}
function limpiar(){
  editId=null;
  for(const k in f){
    if(k==='telefono') continue;
    if('value' in f[k]) f[k].value='';
  }
  resetPhoneInput();
  Promise.resolve(renderServicios()).then(()=>{
    refreshEmailSuggestionsView();
  });
  msg.textContent='';
}

/* ===== Persistencia de correos enlazados ===== */
// Persistencia
const EMAILS_BY_SERVICE_KEY = 'zylo.emailsByService';

function normalizeServiceKey(servicio){
  return String(servicio||'').trim();
}
function normalizeEmailValue(email){
  return String(email||'').trim().toLowerCase();
}
function isValidEmail(email){
  const value = normalizeEmailValue(email);
  return !!value && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
}
function sanitizeEmailsMap(map){
  const clean={};
  if(!map || typeof map!=='object') return clean;
  Object.entries(map).forEach(([service,list])=>{
    const svc=normalizeServiceKey(service);
    if(!svc) return;
    const normalized=Array.isArray(list)? Array.from(new Set(list.map(normalizeEmailValue).filter(isValidEmail))):[];
    if(normalized.length){
      normalized.sort((a,b)=>a.localeCompare(b));
      clean[svc]=normalized;
    }
  });
  return clean;
}
function loadEmailsByService(){
  try{
    const raw=localStorage.getItem(EMAILS_BY_SERVICE_KEY);
    if(!raw) return {};
    const parsed=JSON.parse(raw);
    return sanitizeEmailsMap(parsed);
  }catch(error){
    console.warn('No se pudo leer los correos enlazados.', error);
    return {};
  }
}
function saveEmailsByService(map){
  const clean=sanitizeEmailsMap(map);
  try{
    localStorage.setItem(EMAILS_BY_SERVICE_KEY, JSON.stringify(clean));
  }catch(error){
    console.warn('No se pudo guardar los correos enlazados.', error);
  }
  return clean;
}
function addEmail(map, servicio, email){
  const svc=normalizeServiceKey(servicio);
  const mail=normalizeEmailValue(email);
  if(!svc || !isValidEmail(mail)) return sanitizeEmailsMap(map);
  const next={ ...(map||{}) };
  const current=Array.isArray(next[svc])? next[svc].slice():[];
  if(!current.includes(mail)){
    current.push(mail);
    current.sort((a,b)=>a.localeCompare(b));
  }
  next[svc]=current;
  return sanitizeEmailsMap(next);
}
function removeEmail(map, servicio, email){
  const svc=normalizeServiceKey(servicio);
  const mail=normalizeEmailValue(email);
  if(!svc || !mail) return sanitizeEmailsMap(map);
  const next={ ...(map||{}) };
  const current=Array.isArray(next[svc])? next[svc].slice():[];
  const filtered=current.filter(item=>item!==mail);
  if(filtered.length){ next[svc]=filtered; }
  else{ delete next[svc]; }
  return sanitizeEmailsMap(next);
}
let emailsByService = loadEmailsByService();
function getEmailsForService(servicio){
  const svc=normalizeServiceKey(servicio);
  if(!svc) return [];
  const list=emailsByService[svc];
  return Array.isArray(list)? list.slice():[];
}

window.loadEmailsByService = loadEmailsByService;
window.saveEmailsByService = saveEmailsByService;
window.addEmail = addEmail;
window.removeEmail = removeEmail;
window.isValidEmail = isValidEmail;
window.getEmailsForService = getEmailsForService;

/* ====== Semillas / almacenamiento local de servicios (fallback si no hay sesión) ====== */
const defaultServices = ["ChatGPT","Gemini","YouTube","Disney"];
let localServices = JSON.parse(localStorage.getItem('services_local') || 'null');
if (!Array.isArray(localServices) || !localServices.length) {
  localServices = defaultServices.slice();
  localStorage.setItem('services_local', JSON.stringify(localServices));
}
function saveLocalServices() {
  localServices = Array.from(new Set(localServices)).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  localStorage.setItem('services_local', JSON.stringify(localServices));
}

/* ===== clientes locales ===== */
const LOCAL_CLIENTS_KEY = 'clients_local_v1';
const CLIENTS_LAST_USER_KEY = 'clients_last_uid';
const CLIENTS_CACHE_PREFIX = 'clients_cache_v1:';

function getClientsCacheKey(uid){
  const clean = String(uid||'').trim();
  return clean ? `${CLIENTS_CACHE_PREFIX}${clean}` : null;
}
function loadCachedClientsForUser(uid){
  const key = getClientsCacheKey(uid);
  if(!key) return [];
  try{
    const raw = localStorage.getItem(key); if(!raw) return [];
    const arr = JSON.parse(raw)||[];
    arr.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
    return arr;
  }catch{ return []; }
}
function saveCachedClientsForUser(uid, clients){
  const key = getClientsCacheKey(uid);
  if(!key) return;
  try{
    const clean = (Array.isArray(clients)?clients:[]).slice().sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
    localStorage.setItem(key, JSON.stringify(clean));
  }catch{}
}
function clearCachedClientsForUser(uid){
  const key = getClientsCacheKey(uid);
  if(!key) return;
  try{ localStorage.removeItem(key); }catch{}
}
function loadLocalClients(){
  try{
    const raw=localStorage.getItem(LOCAL_CLIENTS_KEY); if(!raw) return [];
    const arr=JSON.parse(raw)||[];
    arr.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
    return arr;
  }catch{ return []; }
}
let localClients = loadLocalClients();
function saveLocalClients(){
  try{
    localStorage.setItem(LOCAL_CLIENTS_KEY, JSON.stringify(localClients.slice().sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''))));
  }catch{}
}

/* ====== AUTH (Firebase) ====== */
let currentUser = null;
let unsubscribeClientes = null;
let unsubscribeServicios = null;
let snapshotRenderQueue = Promise.resolve();
let latestSnapshotVersion = 0;
let activeSnapshotSession = 0;

function focusUserMenuTriggerAfterPanelClose(shouldRestoreFocus){
  if(!shouldRestoreFocus) return;
  const panel = document.getElementById('userMenu');
  const trigger = document.getElementById('userTrigger');
  if(!panel || !trigger) return;
  if(document.activeElement === trigger) return;
  if(typeof trigger.focus === 'function'){
    trigger.focus({ preventScroll: true });
  }
}

function setUserConfigPanelState(open){
  const panel = document.getElementById('userMenu');
  const trigger = document.getElementById('userTrigger');
  if(!panel || !trigger) return;
  const shouldOpen = typeof open === 'boolean' ? open : panel.classList.contains('hidden');
  const activeElement = document.activeElement;
  const isActiveInsidePanel = !shouldOpen
    && activeElement instanceof Node
    && panel.contains(activeElement);
  if(shouldOpen){
    panel.classList.remove('hidden');
    trigger.setAttribute('aria-expanded', 'true');
  }else{
    panel.classList.add('hidden');
    trigger.setAttribute('aria-expanded', 'false');
  }
  panel.toggleAttribute('hidden', !shouldOpen);
  panel.setAttribute('aria-hidden', shouldOpen ? 'false' : 'true');
  focusUserMenuTriggerAfterPanelClose(isActiveInsidePanel);
}
setUserConfigPanelState(false);
function authUpdateUI(profileData){
  const btnAuthOpen = document.getElementById('btnAuthOpen');
  const authUserShell = document.getElementById('auth-user');
  const btnUserMenu = document.getElementById('userTrigger');
  const userAvatar = document.getElementById('userAvatar');
  const userDisplayNameEl = document.getElementById('userDisplayName');
  const btnLogout = document.getElementById('btnLogout');
  const isLoggedIn = Boolean(currentUser);
  const fallbackName = isLoggedIn ? ((currentUser.displayName || '').trim() || (currentUser.email || '').split('@')[0] || 'Usuario') : '';
  const baseData = isLoggedIn ? {
    displayName: fallbackName,
    email: currentUser.email || '',
    avatarColor: generateAvatarColor(String(currentUser.uid || currentUser.email || fallbackName))
  } : null;
  const data = isLoggedIn ? { ...baseData, ...(profileData || {}) } : null;

  if(btnAuthOpen){
    btnAuthOpen.style.display = isLoggedIn ? 'none' : 'inline-flex';
    btnAuthOpen.disabled = isLoggedIn;
  }

  if(btnLogout){
    btnLogout.disabled = !isLoggedIn;
  }

  if(!isLoggedIn){
    if(authUserShell){
      authUserShell.hidden = true;
      authUserShell.setAttribute('hidden', '');
      authUserShell.setAttribute('aria-hidden', 'true');
    }
    setUserConfigPanelState(false);
    if(btnUserMenu){
      btnUserMenu.setAttribute('aria-label', 'Abrir configuración');
      btnUserMenu.disabled = true;
    }
    if(userAvatar){
      userAvatar.textContent = 'U';
      userAvatar.style.removeProperty('--avatar-color');
    }
    if(userDisplayNameEl){
      userDisplayNameEl.textContent = '';
      userDisplayNameEl.removeAttribute('title');
    }
    return;
  }

  if(authUserShell){
    authUserShell.hidden = false;
    authUserShell.removeAttribute('hidden');
    authUserShell.setAttribute('aria-hidden', 'false');
  }

  if(btnUserMenu){
    const truncated = truncateDisplayName(data.displayName || data.email || 'Usuario');
    btnUserMenu.disabled = false;
    btnUserMenu.setAttribute('aria-label', `Abrir configuración de ${truncated}`);
    const panel = document.getElementById('userMenu');
    btnUserMenu.setAttribute('aria-expanded', String(Boolean(panel && !panel.classList.contains('hidden'))));
    if(userDisplayNameEl){
      userDisplayNameEl.textContent = truncated;
      userDisplayNameEl.title = data.displayName || data.email || truncated;
    }
    if(userAvatar){
      const labelSource = (data.displayName || data.email || 'Usuario').trim();
      const initial = labelSource ? labelSource.charAt(0).toUpperCase() : 'U';
      userAvatar.textContent = initial;
      if(data.avatarColor){
        userAvatar.style.setProperty('--avatar-color', data.avatarColor);
      }else{
        userAvatar.style.setProperty('--avatar-color', generateAvatarColor(labelSource || 'Usuario'));
      }
    }
  }
}
function normalizeRemoteRecord(data){
  if(!data || typeof data !== 'object') return {};
  const ts = data.ts && typeof data.ts.toDate === 'function' ? data.ts.toDate().toISOString() : data.ts || null;
  const updatedAt = data.updatedAt && typeof data.updatedAt.toDate === 'function'
    ? data.updatedAt.toDate().toISOString()
    : data.updatedAt || null;
  return { ...data, ts, updatedAt };
}
function clientesCollection(){
  return currentUser ? collection(firestore, 'users', currentUser.uid, 'clientes') : null;
}
function serviciosDoc(){
  return currentUser ? doc(firestore, 'users', currentUser.uid, 'config', 'services') : null;
}
function subscribeToRemoteClientes(user){
  if(unsubscribeClientes){ unsubscribeClientes(); unsubscribeClientes = null; }
  const sessionId = ++activeSnapshotSession;
  latestSnapshotVersion = 0;
  snapshotRenderQueue = Promise.resolve();
  if(!user){
    cacheClientes = localClients.slice();
    isClientesBootstrapped = true;
    renderTabla(cacheClientes);
    return;
  }
  const hasPreloadedData = Array.isArray(cacheClientes) && cacheClientes.length>0 && isClientesBootstrapped;
  if(!hasPreloadedData){
    isClientesBootstrapped = false;
    cacheClientes = [];
    renderTabla();
  }
  const colRef = clientesCollection();
  if(!colRef) return;
  unsubscribeClientes = onSnapshot(colRef, (snapshot)=>{
    const fresh = snapshot.docs.map(docSnap=>{
      const data = normalizeRemoteRecord(docSnap.data());
      return { id: docSnap.id, ...data };
    });
    fresh.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
    cacheClientes = fresh.slice();
    isClientesBootstrapped = true;
    if(sessionId !== activeSnapshotSession){
      return;
    }
    const version = ++latestSnapshotVersion;
    snapshotRenderQueue = snapshotRenderQueue.catch(()=>{});
    snapshotRenderQueue = snapshotRenderQueue.then(async ()=>{
      if(sessionId !== activeSnapshotSession){
        return;
      }
      if(version < latestSnapshotVersion){
        return;
      }
      try{
        await renderTabla(fresh);
      }catch(error){
        console.error('Error al renderizar clientes tras snapshot', error);
        return;
      }
      if(sessionId !== activeSnapshotSession || version !== latestSnapshotVersion){
        return;
      }
      if(currentUser?.uid){
        try{
          // En snapshot, esperar render y luego guardar caché (render → save).
          saveCachedClientsForUser(currentUser.uid, fresh);
        }catch(error){
          console.warn('No se pudo guardar la caché de clientes', error);
        }
      }
    });
  }, (error)=>{
    console.error('Error al escuchar clientes', error);
    toast('No se pudo cargar tus clientes en tiempo real.');
    isClientesBootstrapped = true;
    renderTabla();
  });
}
function subscribeToRemoteServicios(user){
  if(unsubscribeServicios){ unsubscribeServicios(); unsubscribeServicios = null; }
  if(!user){
    cacheServicios = localServices.slice();
    renderServicios();
    return;
  }
  const docRef = serviciosDoc();
  unsubscribeServicios = onSnapshot(docRef, (snapshot)=>{
    const data = snapshot.exists() ? snapshot.data() : {};
    const items = Array.isArray(data?.items) ? data.items : [];
    cacheServicios = items.map(String).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    renderServicios();
  }, (error)=>{
    console.error('Error al escuchar servicios', error);
    toast('No se pudo cargar la lista de servicios.');
  });
}
async function syncLocalServicesToCloudIfEmpty(){
  if(!currentUser) return;
  const docRef = serviciosDoc();
  if(!docRef) return;
  try{
    const snap = await getDoc(docRef);
    const data = snap.exists() ? snap.data() : {};
    const items = Array.isArray(data?.items) ? data.items : [];
    if(items.length === 0 && localServices.length){
      await setDoc(docRef, { items: localServices.slice(), updatedAt: serverTimestamp() }, { merge: true });
    }
  }catch(error){
    console.error('No se pudo sincronizar servicios locales', error);
  }
}
async function fetchUserProfileData(user, overrides={}){
  if(!user) return null;
  const baseName = ((user.displayName || '').trim()) || ((user.email || '').split('@')[0]) || 'Usuario';
  const fallback = {
    displayName: baseName,
    email: user.email || '',
    avatarColor: generateAvatarColor(String(user.uid || user.email || baseName))
  };
  const initial = { ...fallback, ...(overrides || {}) };
  try{
    const userDocRef = doc(firestore, 'users', user.uid);
    const snapshot = await getDoc(userDocRef);
    if(snapshot.exists()){
      const data = snapshot.data() || {};
      return {
        ...initial,
        ...data,
        displayName: (data.displayName || initial.displayName),
        avatarColor: (data.avatarColor || initial.avatarColor)
      };
    }
  }catch(error){
    console.error('No se pudo obtener el perfil del usuario', error);
  }
  return initial;
}
async function updateUserState(user){
  currentUser = user;
  let profileData = null;
  if(user){
    try{
      const synced = await syncUserProfile(user);
      profileData = await fetchUserProfileData(user, synced);
    }catch(error){
      console.error('No se pudo sincronizar el perfil del usuario', error);
      profileData = await fetchUserProfileData(user);
    }
  }
  await handleClientStorageForUser(user);
  if(user){
    hideLanding();
  }else{
    showLanding('home');
  }
  authUpdateUI(profileData);
  subscribeToRemoteClientes(user);
  subscribeToRemoteServicios(user);
  if(user){ syncLocalServicesToCloudIfEmpty(); }
}
onAuthStateChanged(auth, (user)=>{
  persistenceReadyForInit
    .then(()=>updateUserState(user || null))
    .catch(err=>{
      console.error('No se pudo actualizar el estado del usuario', err);
    });
});
const btnAuthOpen  = document.getElementById('btnAuthOpen');
const btnAuthSubmit= document.getElementById('btnAuthSubmit');
const authEmailEl  = document.getElementById('authEmail');
const authPassEl   = document.getElementById('authPass');
const authErrorEl  = document.getElementById('authError');
const toggleAuthPass = document.getElementById('toggleAuthPass');
const btnForgot    = document.getElementById('btnForgot');
const googleButtonContainer = document.getElementById('googleButton');
const btnUserMenu = document.getElementById('userTrigger');
const btnUserSettings = document.getElementById('btnUserSettings');
const userConfigPanel = document.getElementById('userMenu');
const isUserConfigPanelHidden = () => userConfigPanel?.classList.contains('hidden') ?? true;
const authUserShell = document.getElementById('auth-user');
const settingsModal = document.getElementById('settingsModal');
const btnSettingsClose = document.getElementById('btnSettingsClose');
settingsThemeOptions = Array.from(document.querySelectorAll('input[name="settingsTheme"]'));
updateThemeControls();
settingsThemeOptions.forEach((input)=>{
  input.addEventListener('change', ()=> setThemePreference(input.value));
});

btnAuthOpen?.addEventListener('click', ()=>{
  showLanding('login');
});

function openSettingsModal(){
  if(!settingsModal) return;
  settingsReturnFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
  settingsModal.classList.add('open');
  settingsModal.setAttribute('aria-hidden','false');
  updateThemeControls();
  const focusTarget = settingsModal.querySelector('input[name="settingsTheme"]:checked') || settingsModal.querySelector('input[name="settingsTheme"]');
  if(focusTarget && typeof focusTarget.focus === 'function'){
    focusTarget.focus({ preventScroll:true });
  }
}

function closeSettingsModal(){
  if(!settingsModal) return;
  if(!settingsModal.classList.contains('open')) return;
  settingsModal.classList.remove('open');
  settingsModal.setAttribute('aria-hidden','true');
  const returnTarget = settingsReturnFocus;
  settingsReturnFocus = null;
  if(returnTarget && typeof returnTarget.focus === 'function'){
    setTimeout(()=> returnTarget.focus({ preventScroll:true }),0);
  }
}

btnUserMenu?.addEventListener('click', (event)=>{
  event.preventDefault();
  event.stopPropagation();
  if(btnUserMenu.disabled) return;
  const shouldOpen = isUserConfigPanelHidden();
  setUserConfigPanelState(shouldOpen);
});

btnUserSettings?.addEventListener('click', (event)=>{
  event.preventDefault();
  event.stopPropagation();
  setUserConfigPanelState(false);
  openSettingsModal();
});

btnSettingsClose?.addEventListener('click', (event)=>{
  event.preventDefault();
  closeSettingsModal();
});

settingsModal?.addEventListener('click', (event)=>{
  if(event.target === settingsModal){
    closeSettingsModal();
  }
});

document.addEventListener('click', (event)=>{
  if(!userConfigPanel || isUserConfigPanelHidden()) return;
  if(authUserShell && authUserShell.contains(event.target)) return;
  const shouldRestoreFocus = document.activeElement instanceof Node
    && userConfigPanel.contains(document.activeElement);
  setUserConfigPanelState(false);
  focusUserMenuTriggerAfterPanelClose(shouldRestoreFocus);
});

document.addEventListener('keydown', (event)=>{
  if(event.key !== 'Escape') return;
  if(settingsModal?.classList.contains('open')){
    event.preventDefault();
    closeSettingsModal();
    return;
  }
  if(!isUserConfigPanelHidden()){
    const shouldRestoreFocus = document.activeElement instanceof Node
      && userConfigPanel?.contains(document.activeElement);
    setUserConfigPanelState(false);
    focusUserMenuTriggerAfterPanelClose(shouldRestoreFocus);
  }
});

toggleAuthPass?.addEventListener('click', ()=>{
  const isPass = authPassEl.type==='password';
  authPassEl.type = isPass? 'text':'password';
  toggleAuthPass.textContent = isPass? '🙈':'👁';
});

const googleProvider = new GoogleAuthProvider();

function setFeedback(element, message, tone='danger'){
  if(!element) return;
  element.textContent = message || '';
  element.style.color = tone === 'success' ? 'var(--success)' : tone === 'info' ? 'var(--muted)' : 'var(--danger)';
}

async function signInWithGoogle({ feedbackEl = googleFeedbackEl }={}){
  if(feedbackEl){ setFeedback(feedbackEl, 'Abriendo Google…', 'info'); }
  try{
    const credential = await signInWithPopup(auth, googleProvider);
    await syncUserProfile(credential.user);
    if(feedbackEl){ setFeedback(feedbackEl, 'Sesión iniciada con Google.', 'success'); }
    return credential;
  }catch(error){
    console.error(error);
    if(feedbackEl){ setFeedback(feedbackEl, error.message || 'No se pudo iniciar sesión con Google.'); }
    throw error;
  }
}

if(googleButtonContainer){
  const googleBtn = document.createElement('button');
  googleBtn.type='button';
  googleBtn.className='btn ghost';
  googleBtn.textContent='Continuar con Google';
  googleBtn.addEventListener('click', async ()=>{
    googleBtn.disabled=true;
    try{
      await signInWithGoogle({ feedbackEl: googleFeedbackEl });
    }finally{
      googleBtn.disabled=false;
    }
  });
  googleButtonContainer.innerHTML='';
  googleButtonContainer.appendChild(googleBtn);
}

signupForm?.addEventListener('submit', async (event)=>{
  event.preventDefault();
  signupErrorEl.textContent='';
  const displayName=(signupNameEl.value||'').trim();
  const email=(signupEmailEl.value||'').trim();
  const pass=(signupPassEl.value||'').trim();
  const confirm=(signupConfirmEl.value||'').trim();
  if(!displayName){ signupErrorEl.textContent='Escribe tu nombre para mostrar.'; signupNameEl?.focus(); return; }
  if(!email||!pass){ signupErrorEl.textContent='Completa correo y contraseña.'; return; }
  if(pass.length<8){ signupErrorEl.textContent='La contraseña debe tener al menos 8 caracteres.'; return; }
  if(pass!==confirm){ signupErrorEl.textContent='Las contraseñas no coinciden.'; return; }
  const submitBtn=signupForm.querySelector('button[type="submit"]');
  submitBtn.disabled=true; submitBtn.textContent='Creando cuenta…';
  try{
    const cred=await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName });
    await syncUserProfile(cred.user, { displayName });
    await sendEmailVerification(cred.user);
    signupErrorEl.textContent='';
    window.location.href='verify.html';
    return;
  }catch(error){
    signupErrorEl.textContent=error.message||'Error inesperado.';
  }finally{
    submitBtn.disabled=false;
    submitBtn.textContent='Crear cuenta';
  }
});

loginForm?.addEventListener('submit', async (event)=>{
  event.preventDefault();
  const email=(authEmailEl.value||'').trim();
  const pass=(authPassEl.value||'').trim();
  authErrorEl.textContent='';
  authErrorEl.style.color='var(--danger)';
  if(!email||!pass){ authErrorEl.textContent='Completa correo y contraseña.'; return; }
  btnAuthSubmit.disabled=true; btnAuthSubmit.textContent='Procesando…';
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    authErrorEl.textContent='';
  }catch(error){
    authErrorEl.textContent=error.message||'Error inesperado.';
  }finally{
    btnAuthSubmit.disabled=false;
    btnAuthSubmit.textContent='Entrar';
  }
});

document.getElementById('btnLogout')?.addEventListener('click', async ()=>{
  setUserConfigPanelState(false);
  try{
    await signOut(auth);
  }catch(error){
    console.warn('No se pudo cerrar sesión', error);
  }
});

async function requestPasswordReset(email){
  try{
    await sendPasswordResetEmail(auth, email);
    return { ok:true, message:'Te enviamos un correo para restablecer tu contraseña.' };
  }catch(error){
    return { ok:false, message:error.message || 'No se pudo enviar el correo de recuperación.' };
  }
}

btnForgot?.addEventListener('click', async ()=>{
  const email = (authEmailEl.value||'').trim();
  authErrorEl.style.color = 'var(--danger)'; authErrorEl.textContent = '';
  if(!email){ authErrorEl.textContent = 'Escribe tu correo arriba para enviarte el enlace.'; return; }
  const result = await requestPasswordReset(email);
  authErrorEl.style.color = result.ok ? 'var(--success)' : 'var(--danger)';
  authErrorEl.textContent = result.message;
});

/* ====== DB en la nube (Firebase) ====== */
let cacheClientes = localClients.slice();
let cacheServicios = localServices.slice();
let isClientesBootstrapped = true;

function resetClientMemoryState({ render = true } = {}){
  cacheClientes = [];
  isClientesBootstrapped = false;
  if(unsubscribeClientes){
    try{ unsubscribeClientes(); }catch{}
    unsubscribeClientes = null;
  }
  if(render){
    renderTabla();
  }
}

function clearStoredClients(){
  localClients = [];
  try{ localStorage.removeItem(LOCAL_CLIENTS_KEY); }catch{}
}
function getLastClientsUser(){
  try{ return localStorage.getItem(CLIENTS_LAST_USER_KEY) || null; }catch{ return null; }
}
function rememberLastClientsUser(uid){
  if(!uid) return;
  try{ localStorage.setItem(CLIENTS_LAST_USER_KEY, uid); }catch{}
}
async function handleClientStorageForUser(user){
  const nextUid = user?.uid ? String(user.uid) : null;
  const lastUid = getLastClientsUser();
  if(!nextUid){
    resetClientMemoryState();
    return;
  }
  const cached = loadCachedClientsForUser(nextUid);
  const hasCached = cached.length > 0;
  const isDifferentUser = Boolean(lastUid && lastUid !== nextUid);
  const shouldResetState = !lastUid || isDifferentUser;
  if(shouldResetState){
    resetClientMemoryState({ render: !hasCached });
  }
  if(!lastUid || isDifferentUser){
    rememberLastClientsUser(nextUid);
  }
  if(hasCached){
    cacheClientes = cached.slice();
    isClientesBootstrapped = true;
    // Ruta “caché primero”: no repintar la tabla en blanco cuando hay datos locales.
    await renderTabla(cacheClientes);
  }else{
    cacheClientes = [];
    isClientesBootstrapped = false;
    if(!shouldResetState){
      await renderTabla();
    }
  }
}

function buildRemotePayload(rec){
  const base = {
    nombre: rec.nombre || '',
    email: rec.email || '',
    telefono: rec.telefono || '',
    servicio: rec.servicio || '',
    inicio: rec.inicio || '',
    vence: rec.vence || '',
    categoria: rec.categoria || '',
    notas: rec.notas || '',
    pin: rec.pin || '',
    updatedAt: serverTimestamp()
  };
  base.ts = rec.ts || serverTimestamp();
  return base;
}

const db = {
  getAll(){ return currentUser ? cacheClientes.slice() : localClients.slice(); },
  async fetchAll(){
    if(!currentUser){
      localClients = loadLocalClients();
      cacheClientes = localClients.slice();
      isClientesBootstrapped = true;
    }
    if(currentUser && !isClientesBootstrapped){
      return [];
    }
    return cacheClientes.slice();
  },
  async saveOne(rec){
    if(!currentUser){
      localClients = loadLocalClients();
      const recId = rec.id ?? crypto.randomUUID();
      const idx = localClients.findIndex(x=>x.id===recId);
      const payload = { ...(idx>=0? localClients[idx]:{}), ...rec, id: recId };
      if(idx>=0) localClients[idx] = payload; else localClients.push(payload);
      localClients.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||'')); saveLocalClients();
      cacheClientes = localClients.slice();
      return payload;
    }
    const colRef = clientesCollection();
    if(!colRef) throw new Error('No hay usuario autenticado.');
    const payload = buildRemotePayload(rec);
    if(rec.id){
      await updateDoc(doc(colRef, rec.id), payload);
      return { ...rec };
    }
    const docRef = await addDoc(colRef, { ...payload, createdAt: serverTimestamp() });
    return { ...rec, id: docRef.id };
  },
  async deleteOne(id){
    if(!currentUser){
      localClients = loadLocalClients().filter(x=>x && x.id!==id); saveLocalClients(); cacheClientes = localClients.slice();
      return;
    }
    const colRef = clientesCollection();
    if(!colRef) return;
    await deleteDoc(doc(colRef, id));
  },
  async saveAll(arr){
    if(!currentUser){
      localClients = arr.map(x=>({ ...x }));
      localClients.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
      saveLocalClients();
      cacheClientes = localClients.slice();
      return;
    }
    const colRef = clientesCollection();
    if(!colRef) return;
    const keepIds = new Set();
    for(const item of arr){
      const payload = buildRemotePayload(item);
      if(item.id){
        await setDoc(doc(colRef, item.id), payload, { merge: true });
        keepIds.add(item.id);
      }else{
        const docRef = await addDoc(colRef, { ...payload, createdAt: serverTimestamp() });
        keepIds.add(docRef.id);
      }
    }
    const existingIds = cacheClientes.map(x=>x.id).filter(Boolean);
    await Promise.all(existingIds.filter(id=>!keepIds.has(id)).map(id=>deleteDoc(doc(colRef, id))));
  },
  getServicios(){ return currentUser ? cacheServicios.slice() : localServices.slice(); },
  async fetchServicios(){
    if(!currentUser){
      return localServices.slice();
    }
    return cacheServicios.slice();
  },
  async replaceServicios(list){
    const cleaned = list.map(String).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    if(!currentUser){
      localServices = cleaned;
      saveLocalServices();
      cacheServicios = localServices.slice();
      return;
    }
    const docRef = serviciosDoc();
    if(!docRef) return;
    cacheServicios = cleaned.slice();
    await setDoc(docRef, { items: cacheServicios.slice(), updatedAt: serverTimestamp() }, { merge: true });
  }
};

/* ====== UI dinámica ====== */
async function renderServicios(sel){
  const list = await db.fetchServicios();
  const final = list.length ? list : defaultServices;
  f.servicio.innerHTML = final.map(s=>`<option value="${s}">${s}</option>`).join('');
  if(sel && final.includes(sel)) f.servicio.value=sel; else if(final.length) f.servicio.value=final[0]; else f.servicio.value='';
  refreshEmailSuggestionsView();
}
function waitForNextFrame(){
  return new Promise(resolve=>{
    if(typeof requestAnimationFrame === 'function'){
      requestAnimationFrame(()=>resolve());
    }else{
      setTimeout(resolve,0);
    }
  });
}

async function renderTabla(source){
  const hasExternalSource = Array.isArray(source);
  if(!hasExternalSource && currentUser && !isClientesBootstrapped && cacheClientes.length === 0){
    tbody.innerHTML = '<tr class="table-loading"><td colspan="8" data-label="">Cargando clientes…</td></tr>';
    await waitForNextFrame();
    return;
  }
  const arr = hasExternalSource ? source : await db.fetchAll();
  const list = Array.isArray(arr) ? arr : [];
  const items=list.filter(x=>coincide(x,q?.value)&&pasaEstado(x,filterEstado?.value))
                 .sort((a,b)=> (diasRestantes(a.vence)??1e9) - (diasRestantes(b.vence)??1e9));
  tbody.innerHTML=items.map(x=>{
    const d=diasRestantes(x.vence); const est=estadoDe(x.vence);
    const tag=est==='vigente'?'ok':est==='pronto'?'warn':'bad';
    const estTxt=est?est[0].toUpperCase()+est.slice(1):'-';
    const diasTxt= d==null?'-':(d<0?`Vencido ${Math.abs(d)} d`:`Faltan ${d} d`);
    return `<tr class="has-row-menu" tabindex="0" aria-haspopup="menu" aria-expanded="false">
      <td data-label="Nombre">${esc(x.nombre)}</td>
      <td data-label="Email">${esc(x.email||'')}</td>
      <td data-label="Servicio">${esc(x.servicio||'')}</td>
      <td data-label="Inicio">${fmt(x.inicio)}</td>
      <td data-label="Vence">${fmt(x.vence)}</td>
      <td data-label="Estado">${est?`<span class="tag ${tag}">${estTxt}</span>`:'-'}</td>
      <td data-label="Días">${diasTxt}</td>
      <td data-label="Acciones" class="cell-actions">
        <div class="menu-wrap">
          <div class="row-menu-indicator" aria-hidden="true"><span class="dots">⋯</span></div>
          <div class="menu" role="menu" aria-hidden="true">
            <button class="menu-item" role="menuitem" data-action="edit" data-id="${x.id}">✎ Editar</button>
            <button class="menu-item" role="menuitem" data-action="label" data-id="${x.id}">🏷 Etiqueta</button>
            <button class="menu-item danger" role="menuitem" data-action="delete" data-id="${x.id}">🗑 Eliminar</button>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
  await waitForNextFrame();
}
function coincide(x,qq){
  qq=(qq||'').trim().toLowerCase(); if(!qq) return true;
  return [x.nombre,x.email,x.servicio,x.telefono,x.categoria,x.notas].some(v=>(v||'').toLowerCase().includes(qq));
}
function pasaEstado(x,f){ if(!f) return true; return estadoDe(x.vence)===f; }

$('#btnLimpiar').onclick=limpiar;

/* ===== EMAIL dropdown (principal) ===== */
function rebuildEmailSuggestions(){
  emailSuggestionCache = getEmailsForService(f.servicio?.value||'');
}
function isEmailSuggestionDropdownOpen(){ return emailSuggestionDropdown?.classList.contains('open'); }
function hideEmailSuggestionDropdown(){
  if(!emailSuggestionDropdown) return;
  emailSuggestionDropdown.classList.remove('open');
  emailSuggestionDropdown.setAttribute('aria-hidden','true');
  f.email?.setAttribute('aria-expanded','false');
  if(emailDropdownToggle) emailDropdownToggle.setAttribute('aria-expanded','false');
  emailSuggestionDropdown.innerHTML=''; filteredEmailSuggestions=[]; activeEmailSuggestionIndex=-1;
  if(hideEmailSuggestionTimeout){ clearTimeout(hideEmailSuggestionTimeout); hideEmailSuggestionTimeout=null; }
}
function updateEmailSuggestionDropdown(filterText){
  if(!emailSuggestionDropdown) return;
  const term = typeof filterText==='string'? filterText.trim().toLowerCase() : (f.email?.value||'').trim().toLowerCase();
  filteredEmailSuggestions = (emailSuggestionCache||[]).filter(item=> !term || item.toLowerCase().includes(term));

  if(!filteredEmailSuggestions.length){
    emailSuggestionDropdown.innerHTML=`<div class="suggestion-empty">${esc(term ? 'Sin coincidencias' : 'Sin correos enlazados')}</div>`;
  }else{
    emailSuggestionDropdown.innerHTML = filteredEmailSuggestions.map((item,idx)=>{
      return `<button type="button" class="suggestion-item" data-index="${idx}" role="option" id="emailopt-${idx}">
                <span class="suggestion-email">${esc(item)}</span>
              </button>`;
    }).join('');
    Array.from(emailSuggestionDropdown.querySelectorAll('.suggestion-item')).forEach(btn=>{
      btn.addEventListener('mousedown',e=>e.preventDefault());
      btn.addEventListener('click',()=> selectEmailSuggestion(Number(btn.dataset.index)));
    });
  }
  emailSuggestionDropdown.classList.add('open');
  emailSuggestionDropdown.setAttribute('aria-hidden','false');
  f.email?.setAttribute('aria-expanded','true');
  if(emailDropdownToggle) emailDropdownToggle.setAttribute('aria-expanded','true');
  activeEmailSuggestionIndex=-1;
}
function highlightEmailSuggestion(idx){
  if(!emailSuggestionDropdown) return;
  const items=Array.from(emailSuggestionDropdown.querySelectorAll('.suggestion-item'));
  items.forEach((el,i)=>{ el.classList.toggle('is-active', i===idx); if(i===idx){ el.setAttribute('aria-selected','true'); f.email?.setAttribute('aria-activedescendant', el.id); } else { el.removeAttribute('aria-selected'); }});
  if(idx>=0 && items[idx]) items[idx].scrollIntoView({ block:'nearest' });
}
function moveEmailSuggestion(delta){
  if(!filteredEmailSuggestions.length){ updateEmailSuggestionDropdown(); if(!filteredEmailSuggestions.length) return; }
  if(!isEmailSuggestionDropdownOpen()) updateEmailSuggestionDropdown();
  activeEmailSuggestionIndex=(activeEmailSuggestionIndex+delta+filteredEmailSuggestions.length)%filteredEmailSuggestions.length;
  highlightEmailSuggestion(activeEmailSuggestionIndex);
}
function selectEmailSuggestion(idx){
  const email=filteredEmailSuggestions[idx]; if(!email) return;
  if(f.email) f.email.value=email;
  hideEmailSuggestionDropdown();
}
function showEmailSuggestions(){
  rebuildEmailSuggestions();
  updateEmailSuggestionDropdown(f.email.value);
}
// Integración
function refreshEmailSuggestionsView(){
  rebuildEmailSuggestions();
  if(document.activeElement===f.email){
    updateEmailSuggestionDropdown(f.email.value);
  }else{
    hideEmailSuggestionDropdown();
  }
}

/* eventos principal */
if(f.servicio){ ['change','input'].forEach(evt=> f.servicio.addEventListener(evt, ()=>{
  refreshEmailSuggestionsView();
}));}
if(f.email){
  f.email.addEventListener('focus',()=>{ showEmailSuggestions(); });
  f.email.addEventListener('click',()=>{ showEmailSuggestions(); });
  f.email.addEventListener('input',()=>{ updateEmailSuggestionDropdown(f.email.value); });
  f.email.addEventListener('keydown',(e)=>{
    if(e.key==='ArrowDown'){ e.preventDefault(); moveEmailSuggestion(1); }
    else if(e.key==='ArrowUp'){ if(isEmailSuggestionDropdownOpen()){ e.preventDefault(); moveEmailSuggestion(-1); } }
    else if(e.key==='Enter'){ if(isEmailSuggestionDropdownOpen() && activeEmailSuggestionIndex>=0){ e.preventDefault(); selectEmailSuggestion(activeEmailSuggestionIndex); } }
    else if(e.key==='Escape'){ if(isEmailSuggestionDropdownOpen()){ e.preventDefault(); hideEmailSuggestionDropdown(); } }
  });
  f.email.addEventListener('blur',()=>{ hideEmailSuggestionTimeout=setTimeout(()=>hideEmailSuggestionDropdown(),120); });
}
emailSuggestionDropdown?.addEventListener('mouseenter',()=>{ if(hideEmailSuggestionTimeout){ clearTimeout(hideEmailSuggestionTimeout); hideEmailSuggestionTimeout=null; }});
emailSuggestionDropdown?.addEventListener('mouseleave',()=>{ hideEmailSuggestionTimeout=setTimeout(()=>hideEmailSuggestionDropdown(),120); });
emailDropdownToggle?.addEventListener('click', (e)=>{ e.preventDefault(); if(isEmailSuggestionDropdownOpen()) hideEmailSuggestionDropdown(); else showEmailSuggestions(); });

/* selección contextual */
/* ===== Modal Enlazar correo ===== */
const emailLinkerModal = document.getElementById('emailLinkerModal');
const emailLinkerOpenBtn = document.getElementById('emailLinkerOpen');
const emailLinkerCloseBtn = document.getElementById('emailLinkerClose');
const emailLinkerService = document.getElementById('emailLinkerService');
const emailLinkerEmail = document.getElementById('emailLinkerEmail');
const emailLinkerAddBtn = document.getElementById('emailLinkerAdd');
const emailLinkerList = document.getElementById('emailLinkerList');
const emailLinkerError = document.getElementById('emailLinkerError');

function renderEmailLinkerList(service){
  if(!emailLinkerList) return;
  const svc=normalizeServiceKey(service);
  emailLinkerList.innerHTML='';
  if(!svc){
    emailLinkerList.innerHTML=`<div class="email-linker-empty">Selecciona un servicio</div>`;
    return;
  }
  const items=getEmailsForService(svc);
  if(!items.length){
    emailLinkerList.innerHTML=`<div class="email-linker-empty">Sin correos enlazados</div>`;
    return;
  }
  emailLinkerList.innerHTML=items.map(email=>`
    <div class="email-linker-item" role="listitem">
      <span class="email-linker-mail">${esc(email)}</span>
      <button type="button" class="email-linker-remove" data-email="${esc(email)}">Eliminar</button>
    </div>
  `).join('');
}
function populateEmailLinkerServices(){
  if(!emailLinkerService) return Promise.resolve();
  const previous=emailLinkerService.value;
  emailLinkerService.innerHTML='';
  return db.fetchServicios().then(list=>{
    const servicios=Array.from(new Set((Array.isArray(list)?list:[]).map(s=>String(s||'').trim()).filter(Boolean)));
    if(!servicios.length){
      const opt=document.createElement('option');
      opt.value=''; opt.textContent='Sin servicios disponibles'; opt.disabled=true; opt.selected=true;
      emailLinkerService.appendChild(opt);
      emailLinkerService.disabled=true;
      if(emailLinkerEmail){ emailLinkerEmail.value=''; emailLinkerEmail.disabled=true; }
      if(emailLinkerAddBtn) emailLinkerAddBtn.disabled=true;
      if(emailLinkerList){ emailLinkerList.innerHTML=`<div class="email-linker-empty">Agrega servicios para enlazar correos</div>`; }
      return;
    }
    emailLinkerService.disabled=false;
    servicios.forEach(servicio=>{
      const opt=document.createElement('option');
      opt.value=servicio; opt.textContent=servicio;
      emailLinkerService.appendChild(opt);
    });
    const next=(previous && servicios.includes(previous)) ? previous : servicios[0];
    emailLinkerService.value=next||'';
    if(emailLinkerEmail){ emailLinkerEmail.disabled=false; emailLinkerEmail.value=''; }
    if(emailLinkerAddBtn) emailLinkerAddBtn.disabled=false;
    renderEmailLinkerList(emailLinkerService.value);
  });
}
function commitEmailsByService(nextMap){
  emailsByService=saveEmailsByService(nextMap);
  refreshEmailSuggestionsView();
}
function handleEmailLinkerAdd(){
  if(!emailLinkerAddBtn || emailLinkerAddBtn.disabled) return;
  const servicio=emailLinkerService?.value||'';
  const rawEmail=emailLinkerEmail?.value||'';
  if(emailLinkerError) emailLinkerError.textContent='';
  if(!servicio){
    if(emailLinkerError) emailLinkerError.textContent='Selecciona un servicio.';
    emailLinkerService?.focus();
    return;
  }
  const normalized=normalizeEmailValue(rawEmail);
  if(!isValidEmail(normalized)){
    if(emailLinkerError) emailLinkerError.textContent='Ingresa un correo válido.';
    emailLinkerEmail?.focus();
    return;
  }
  const existing=getEmailsForService(servicio);
  if(existing.includes(normalized)){
    if(emailLinkerError) emailLinkerError.textContent='Ese correo ya está enlazado.';
    if(emailLinkerEmail){ emailLinkerEmail.focus(); emailLinkerEmail.select(); }
    return;
  }
  const updated=addEmail(emailsByService, servicio, normalized);
  commitEmailsByService(updated);
  renderEmailLinkerList(servicio);
  if(emailLinkerEmail){ emailLinkerEmail.value=''; emailLinkerEmail.focus(); }
  toast('Correo enlazado agregado ✓');
}
function removeEmailForService(servicio,email){
  const normalized=normalizeEmailValue(email);
  if(!normalized) return;
  const existing=getEmailsForService(servicio);
  if(!existing.includes(normalized)) return;
  const updated=removeEmail(emailsByService, servicio, normalized);
  commitEmailsByService(updated);
  renderEmailLinkerList(servicio);
  toast('Correo enlazado eliminado ✓');
}
// Modal
function setEmailLinkerOpen(isOpen){
  if(!emailLinkerModal) return;
  if(isOpen){
    emailLinkerModal.classList.add('open');
    emailLinkerModal.setAttribute('aria-hidden','false');
    if(emailLinkerError) emailLinkerError.textContent='';
    populateEmailLinkerServices().finally(()=>{
      window.requestAnimationFrame(()=> emailLinkerEmail?.focus());
    });
  }else{
    emailLinkerModal.classList.remove('open');
    emailLinkerModal.setAttribute('aria-hidden','true');
  }
}
window.setEmailLinkerOpen = setEmailLinkerOpen;
emailLinkerAddBtn?.addEventListener('click', handleEmailLinkerAdd);
emailLinkerEmail?.addEventListener('keydown', (event)=>{
  if(event.key==='Enter'){ event.preventDefault(); handleEmailLinkerAdd(); }
});
emailLinkerEmail?.addEventListener('input', ()=>{ if(emailLinkerError) emailLinkerError.textContent=''; });
emailLinkerService?.addEventListener('change', ()=>{
  if(emailLinkerError) emailLinkerError.textContent='';
  if(emailLinkerEmail){ emailLinkerEmail.value=''; window.requestAnimationFrame(()=> emailLinkerEmail.focus()); }
  renderEmailLinkerList(emailLinkerService.value);
});
emailLinkerList?.addEventListener('click', (event)=>{
  const btn=event.target.closest('.email-linker-remove');
  if(!btn) return;
  const servicio=emailLinkerService?.value||'';
  const email=btn.getAttribute('data-email')||'';
  if(!servicio||!email) return;
  removeEmailForService(servicio,email);
});
emailLinkerCloseBtn?.addEventListener('click', ()=> setEmailLinkerOpen(false));
emailLinkerModal?.addEventListener('click', (event)=>{
  if(event.target===emailLinkerModal) setEmailLinkerOpen(false);
});
document.addEventListener('keydown', (event)=>{
  if(event.key==='Escape' && emailLinkerModal?.classList.contains('open')){
    setEmailLinkerOpen(false);
  }
});
// Sidebar
emailLinkerOpenBtn?.addEventListener('click', ()=> setEmailLinkerOpen(true));
/* ===== Acciones tabla ===== */
$('#btnGuardar').onclick = async ()=>{
  const data={
    nombre:f.nombre.value.trim(), email:f.email.value.trim(), telefono:getPhoneValue(),
    servicio:f.servicio.value, inicio:f.inicio.value, vence:f.vence.value,
    categoria:f.categoria.value, notas:f.notas.value.trim(), pin:f.pin.value.trim(), ts:Date.now()
  };
  if(editId!==null && editId!==undefined) data.id = editId;
  if(!data.nombre){ toast('Escribe un nombre'); return; }
  const wasGuest = !currentUser;
  try{
    await db.saveOne(data); await renderTabla(); limpiar();
    showView('clientes');
    toast(wasGuest && !currentUser ? 'Guardado local ✓  Accede para sincronizar' : 'Guardado ✓');
  }catch(err){ toast(err?.message || 'No se pudo guardar.'); }
};
function editar(id){
  const x=db.getAll().find(c=>c.id===id); if(!x) return; editId=x.id;
  showView('form',{skipFocus:true});
  for(const k in f){
    if(k==='telefono') continue;
    if(k in x) f[k].value=x[k]||'';
  }
  applyPhoneValue(x.telefono);
  msg.textContent='Editando… guarda para aplicar cambios';
  formSection?.scrollIntoView({ behavior:'smooth', block:'start' });
  f.nombre?.focus();
}
async function borrar(id){
  if(!confirm('¿Eliminar este cliente?')) return;
  await db.deleteOne(id); await renderTabla();
}

/* Menús (kebab + tema) + cierre fuera de la fila activa */
function getMenuController(menu){
  if(!menu) return null;
  const wrap=menu.closest('.menu-wrap');
  if(wrap){ const control=wrap.querySelector('[aria-haspopup="menu"]'); if(control) return control; }
  return menu.closest('tr.has-row-menu');
}
function setMenuState(menu,isOpen){
  if(!menu) return;
  if(isOpen){ menu.classList.add('open'); menu.setAttribute('aria-hidden','false'); }
  else{ menu.classList.remove('open'); menu.setAttribute('aria-hidden','true'); }
  const controller=getMenuController(menu);
  if(controller){ controller.setAttribute('aria-expanded',isOpen?'true':'false'); }
}
function closeAllMenus(except=null){
  document.querySelectorAll('.menu.open').forEach(menu=>{
    if(except && menu===except) return; setMenuState(menu,false);
  });
}
document.addEventListener('click',(e)=>{
  const wrap=e.target.closest('.menu-wrap');
  const toggle=e.target.closest('[data-menu-toggle]');
  const item=e.target.closest('.menu-item');
  const rowTrigger=e.target.closest('tr.has-row-menu');

  if(toggle){
    const menu=toggle.closest('.menu-wrap')?.querySelector('.menu'); if(!menu) return;
    const isOpen=menu.classList.contains('open');
    if(isOpen) setMenuState(menu,false); else { closeAllMenus(menu); setMenuState(menu,true); }
    return;
  }
  if(item){
    const id=item.dataset.id;
    if(item.dataset.action==='edit') editar(id);
    else if(item.dataset.action==='label') etiquetar(id);
    else if(item.dataset.action==='delete') borrar(id);
    closeAllMenus(); return;
  }

  // Cierra si haces clic FUERA de la fila activa
  const openMenu = document.querySelector('.menu.open');
  if(openMenu){
    const openRow = openMenu.closest('tr.has-row-menu');
    if(!rowTrigger || rowTrigger !== openRow){ setMenuState(openMenu,false); }
  }

  // Si clicas completamente fuera de cualquier fila/menu, cierra todo
  if(!wrap && !rowTrigger){ closeAllMenus(); }
});
if(tbody){
  tbody.addEventListener('click',(e)=>{
    const row=e.target.closest('tr.has-row-menu'); if(!row || !tbody.contains(row)) return;
    if(e.target.closest('.menu')) return;
    const menu=row.querySelector('.menu'); if(!menu) return;
    const isOpen=menu.classList.contains('open');
    if(isOpen) setMenuState(menu,false); else { closeAllMenus(menu); setMenuState(menu,true); }
  });
  tbody.addEventListener('keydown',(e)=>{
    if(e.key!=='Enter' && e.key!==' ') return;
    const row=e.target.closest('tr.has-row-menu'); if(!row || !tbody.contains(row)) return;
    const menu=row.querySelector('.menu'); if(!menu) return;
    e.preventDefault();
    const isOpen=menu.classList.contains('open');
    if(isOpen){ setMenuState(menu,false); } else { closeAllMenus(menu); setMenuState(menu,true); const first=menu.querySelector('.menu-item'); first?.focus(); }
  });
}
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeAllMenus(); });

/* ===== Botones + y − de servicios ===== */
$('#btnAgregarServicio').onclick = async ()=>{
  const nombre = (prompt('Nombre del nuevo servicio:') || '').trim();
  if (!nombre) return;
  const actuales = await db.fetchServicios();
  if (!actuales.includes(nombre)) {
    actuales.push(nombre); actuales.sort((a,b)=>a.localeCompare(b)); await db.replaceServicios(actuales);
    toast(currentUser ? 'Servicio agregado ✓' : 'Servicio agregado (local) ✓  Accede para guardar en la nube');
    await renderServicios(nombre);
  } else { await renderServicios(nombre); toast('Ese servicio ya existe'); }
};
$('#btnEliminarServicio').onclick = async ()=>{
  const current = f.servicio.value; if (!current) { toast('No hay servicio seleccionado'); return; }
  const actuales = await db.fetchServicios(); if (!actuales.includes(current)) { toast('Ese servicio no está en la lista'); return; }
  if (!confirm(`¿Eliminar "${current}" de la lista de servicios?\n(No afecta a los clientes ya guardados).`)) return;
  const nueva = actuales.filter(s => s !== current); await db.replaceServicios(nueva);
  toast(currentUser ? 'Servicio eliminado ✓' : 'Servicio eliminado (local) ✓  Accede para guardar en la nube'); await renderServicios();
};

/* Mostrar/Ocultar PIN (form) */
document.getElementById('togglePin')?.addEventListener('click',()=>{ const el=f.pin; const isPass=el.type==='password'; el.type=isPass?'text':'password'; document.getElementById('togglePin').textContent=isPass?'🙈':'👁'; });

/* ===== Etiquetas ===== */
function formatDM(iso){ if(!iso) return ''; const d=new Date(iso+'T00:00:00'); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0'); }
function buildEtiqueta(c){
  const svc = (c.servicio || '').toString().toUpperCase();
  const fv = formatDM(c.vence) || '--/--';
  const correo = c.email || '—';
  const perfil = c.nombre || '—';
  const pin = c.pin || '—';
  const password = c.password || c.contrasena || c.pass || c.clave || '—';
  return `✨ *${svc || 'SERVICIO'}* 
━━━━━━━━━━━━━━━
📅 *Vence:* ${fv}

👥 *Perfil & Acceso*
   • Nombre: ${perfil}
   • Correo: ${correo}
   • Contraseña: ${password}
   • PIN: ${pin}
━━━━━━━━━━━━━━━

💻📲  🌟 Gracias por tu compra`;
}
async function copyToClipboard(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(e){ try{ var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; }catch(_){ return false; } }
}
function etiquetar(id){
  var c=db.getAll().find(x=>x.id===id); if(!c){ toast('Cliente no encontrado'); return; }
  var etiqueta = buildEtiqueta(c);
  copyToClipboard(etiqueta).then(ok=> toast(ok?'Etiqueta copiada ✓':'No se pudo copiar'));
}

/* ===== Búsqueda / filtro ===== */
q?.addEventListener('input', () => renderTabla());
filterEstado?.addEventListener('change', () => renderTabla());

</script>
</body>
</html>
